<meta name="monetization" content="$coil.xrptipbot.com/6HaeJVXvS-WQLcNU4uAdgg">
<style>
  span {
    min-height: 40px;
    display: inline-flex;
    align-items: center;
  }
  .m {
    background-color:#ffa; width:100%; cursor:pointer
  }
  .m:hover {
    background-color:#0af
  }
</style>

<!--
  ///#define _menu_ m
  ///#define _back_ b
  ///#define _home_ h
  
  ///#define _newgame_ ng

  ///#define _touchA_ tA
  ///#define _touchB_ tB
  ///#define _touchL_ tL
  ///#define _touchD_ tD
  ///#define _touchR_ tR
  ///#define _touchU_ tU

  ///#define _menuDiv_ md
  ///#define _messageDiv_ sd

  ///#define n.png n
  ///#define d.png d
  ///#define t.png t
-->

<!-- top navigation bar-->
<span><img src="n.png" usemap="#n" id=ni><span id=n></span></span><br>
<map name="n">
  <area shape="rect" id=_menu_ coords="0,0,50,50">
  <area shape="rect" id=_back_ coords="50,0,100,50">
  <area shape="rect" id=_home_ coords="100,0,150,50">
</map>

<canvas id=a width=640 height=640></canvas>

<br>

<!-- dpad touch controls -->
<img src="d.png" id=d usemap="#d"><br>
<map name="d">
  <area shape="poly" id=_touchL_ coords="0,0, 0,240, 110,122" />
  <area shape="poly" id=_touchR_ coords="220,0, 110,122, 220,240" />
  <area shape="poly" id=_touchU_ coords="0,0, 110,122, 240,0" />
  <!--<area shape="poly" id=_touchD_ coords="0,240, 110,122, 220,240" />--> <!-- we don't use the down button! -->
  <area shape="rect" id=_touchA_ coords="517, 22, 630, 160" />
  <area shape="rect" id=_touchB_ coords="398, 74, 517, 212" />
</map>

<div id="_menuDiv_">
  <div id="_menuDiv_m">
    <p>thanks for supporting
    <p>saving progress
  </div>
  <div id="_menuDiv_nm">
    <!--<p>demo mode-->
    <p class="m">> <a href="https://coil.com/" target=_blank>enable game saves with coil</a>
  </div>
  <p class="m">> <a href="https://grapefruitopia.itch.io" target="_blank">grapefruitopia.itch.io</a><p class="m" onclick="_newgame_()">> new game
</div>
<div id="_messageDiv_"><center><span id="mt">!</span></center></div>

<script>
  /* eslint-disable no-undef, no-unused-vars, no-extra-semi, no-with, no-empty, no-sparse-arrays, no-global-assign */

  ///#define true 1
  ///#define false 0

  ///#define "singsong" "ssdd-v1"

  a.onclick = _ => {
    _menuDiv_.style.display = "none"
  };

  ///#define _randomInt_ R
  _randomInt_ = i => Math.floor(Math.random()*i);

  ///#define _monetization_ mz
  _monetization_ = false;

///#if UNMINIFIED
//  _monetization_ = true;  // fake monetization on the un-minified version
///#endif

  // monentization stuff
  if (document.monetization) {
    document.monetization.addEventListener("monetizationstart", e => {
      _monetization_ = true
    })
  };

  ///#define _updateMenu_ um
  _updateMenu_ = _ => {
    if (_monetization_) {
      _menuDiv_m.style.display = "block";
      _menuDiv_nm.style.display = "none"
    } else {
      _menuDiv_m.style.display = "none";
      _menuDiv_nm.style.display = "block"
    }
  };

  ///#define _showMessage_ ms
  _showMessage_tm = 0;
  _showMessage_ = m => {
    mt.textContent = m;
    _messageDiv_.style.display = "block";
    clearTimeout(_showMessage_tm);
    _showMessage_tm = setTimeout(_ => {
      _messageDiv_.style.display = "none"
    },5000)
  };

  ///#define _canvasContext_ c
  with (_canvasContext_ = a.getContext("2d")) imageSmoothingEnabled = 0, lineWidth = 10, strokeStyle = "#400", textAlign="center";

  ///#define _tiles_ T
  with (_tiles_ = new Image) src = "t.png";

  ///#define _startLevel_ sl
  ///#define prettifyLevel pl
  ///#define _world_ w
  ///#define _stack_ s
  ///#define _inventory_ i
  ///#define _globalData_ g
  ///#define _notes_ n
  ///#define _levelname_ n
  ///#define _enemies_ e
  ///#define _drop_ d
  ///#define _action_ a
  ///#define _map_ m
  ///#define _background_ b
  ///#define _portals_ p
  ///#define _title_ t
  ///#define _message_ s
  ///#define _overlay_ o
  ///#define _startx_ x
  ///#define _starty_ y
  ///#define _goBack_ gb

  ///#define /*--
  ///#define --*/

  _goBack_ = _ => {
    if (_world_._globalData_._stack_.length > 0) _startLevel_(_world_._globalData_._stack_.pop(), true)
  };

  _back_.addEventListener("click", e => _goBack_());
  _home_.addEventListener("click", e => { 
   _startLevel_("s"); _world_._globalData_._stack_ = [] 
  });

  _menu_.addEventListener("click", e => {
    _updateMenu_();
    if (_menuDiv_.style.display == "block") {
      _menuDiv_.style.display = "none"
    } else {
      _menuDiv_.style.display = "block"
    }

///#if UNMINIFIED
    console.log("Show menu!")
///#endif
  });

  ///#define _cancelEvent_ ce
  _cancelEvent_ = e => {
    if (e) {
      e.preventDefault();
      e.stopPropagation();
      e.cancelBubble = true;
      e.returnValue = false
    }
  };

  sh = 945; // screen height
  os = -878; // offset for menu item overlays

  //zoom the page to fit the window
  onresize = e => {
    document.body.style.zoom = Math.min(window.innerWidth / 656, window.innerHeight / sh);
    document.body.style.paddingTop = ((window.innerHeight / document.body.style.zoom) - sh) / 2
  };

  document.bgColor = "#fff";
  with (document.body.style) maxWidth = 640,margin = "auto", overflow = "hidden", fontFamily = "sans-serif", fontSize = 24;

  ///#define _keyDown_ kd
  ///#define _keyUp_ ku

  if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
    // touch events on Android/iOS

    // bigger top buttons for touch
    ni.style.zoom = 1.5;

    // prevent long press menu from appearing when using touch controls
    d.ontouchstart = d.ontouchmove = d.ontouchend = d.ontouchcancel = _cancelEvent_;

    _touchL_.addEventListener("touchstart", e => _keyDown_(37, e), { passive: false });
    _touchL_.addEventListener("touchend", e => _keyUp_(37, e), { passive: false });
    _touchR_.addEventListener("touchstart", e => _keyDown_(39, e), { passive: false });
    _touchR_.addEventListener("touchend", e => _keyUp_(39, e), { passive: false });
    _touchU_.addEventListener("touchstart", e => _keyDown_(38, e), { passive: false });
    _touchU_.addEventListener("touchend", e => _keyUp_(38, e), { passive: false });
    _touchA_.addEventListener("touchstart", e => _keyDown_(32, e), { passive: false });
    _touchA_.addEventListener("touchend", e => _keyUp_(32, e), { passive: false });
    _touchB_.addEventListener("touchstart", e => _keyDown_(18, e), { passive: false });
    _touchB_.addEventListener("touchend", e => _keyUp_(18, e), { passive: false })
  } else {
    // probably not touch, so hide onscreen controls
    d.style.display = "none";
    sh = 694;
    os = -664
  };

  // position menu
  with (_menuDiv_.style) background = "#ffa", opacity = 0.9, padding = 5, position = "relative", top = os, left = 3, width = 400, display = "none";
  with (_messageDiv_.style) background = "#ffa", opacity = 0.9, padding = 5, position = "relative", top = os+573, left = 15, width = 600, display = "none";

  onresize();

  pf = 0;  // player frame

  dx = 0;  // player speed in x
  dy = 0;  // player speed in y

  jx = 0;  // player speed in x from wall jump

  ///#define _dead_ D
  ///#define _invunerable_ iv
  _dead_ = false;
  _invunerable_ = 0;

  _world_ = {
    _globalData_: {
      _stack_: [],
      _inventory_: [],
      _notes_: 0
    },
    
    ////////////////////////////////////////////////////////////////////////////////////////////////////////
    s: { // start level
      _title_: "the start",
      _map_: [
        [-2, -2, -2, -2, -2, -2, -2, -2, -2, -2],
        [-2, 34, 34, 34, 34, 34, 34, 34, 34, -2],
        [-2, 34, -2, -2, -2, -2, -2, -2, 34, -2],
        [-2, 34, -2, -2, -2, -2, -2, -2, 34, -2],
        [-2, 34, -2, -2, -2, -2, -2, -2, 34, -2],
        [-2, 34, -2, 90, -2, -2, -2, -2, 34, -2],
        [-2, 34, -2,291, -2, -2, -2, -2, 34, -2],
        [-2, 34, -2,  9, 28, 18, 38, -2, 34, -2],
        [-2, 34, 34, 34, 34, 34, 34, 34, 34, -2],
        [-2, -2, -2, -2, -2, -2, -2, -2, -2, -2]
      ],
      _background_: "#555",
      _portals_: { 9: "b01", 19: "r01", 29: "g01", 39: "y01", 67: "se" },
      _overlay_: [
        {x:250, y:226, t:"sing", f:"bold 40px sans-serif", c:"#0af"}, // blue
        {x:358, y:234, t:"song", f:"bold 40px sans-serif", c:"#fa0"}, // orange
        {x:300, y:230, t:"-", f:"bold 40px sans-serif", c:"#ffa"}, // yellow
        {x:380, y:295, t:"#js13k 2019", f:"15px sans-serif", c:"#ffa"},
        {x:288, y:270, t:"ding", f:"bold 40px sans-serif", c:"#f50"}, // red
        {x:398, y:278, t:"dong", f:"bold 40px sans-serif", c:"#0f5"}, // green
        {x:340, y:274, t:"-", f:"bold 40px sans-serif", c:"#ffa"}, // yellow
        {x:320, y:550, t:"a game by richard munn.", f:"24px sans-serif", c:"#ffa"}
      ],
      _action_: [ 
        { l:"b02",  x: 1, y: 0, t: 5  }, 
        { l:"b04",  x: 1, y: 4, t: 5  }, 
        { l:"b08",  x: 1, y: 0, t: 5  }, 

        { l:"r02",  x: 1, y: 6, t: 5  }, 
        { l:"r08",  x: 8, y: 1, t: 5  }, 

        { l:"g02",  x: 3, y: 9, t: 5  }, 
        { l:"g05",  x: 8, y: 2, t: 5  }, 
        { l:"g08",  x: 1, y: 3, t: 5  }, 

        { l:"y02",  x: 2, y: 6, t: 5  }, 
        { l:"y04",  x: 8, y: 1, t: 5  }
      ],
      _startx_: 288,
      _starty_: 450
    },

    ////////////////////////////////////////////////////////////////////////////////////////////////////////
 
    se: { 
      _title_: "the end",
      _map_: [
        [59, -1, -1, -1, -1, -1, -1, -1, -1, 59],
        [59, 83, -1, -1, -1, -1, -1, -1, 82, 59],
        [59, -1, -1, -1, -1, -1, -1, -1, -1, 59],
        [59, -1, -1, -1, -1, -1, -1, -1, -1, 59],
        [59, -1, -1, -1, -1, -1, -1, -1, -1, 59],
        [59, 83, -1, -1, -1, -1, -1, -1, 82, 59],
        [59, -1, -1, -1, -1, -1, -1, -1, -1, 59],
        [59,133,133, 33,133, 33,133, 33,133, 59],
        [34, 34, 34, 34, 34, 34, 34, 34, 34, 34],
        [34, 34, 34, 34, 34, 34, 34, 34, 34, 34]
      ],
      _background_: "#33f",
      _portals_: {},
      _overlay_: [
        {x:320, y:180, t:"congratulations", f:"bold 60px sans-serif", c:"#0af"}, // blue

        {x:320, y:280, t:"your song is ok, but could improve", f:"bold 30px sans-serif", c:"#f50"}, // red
        {x:320, y:280, t:"your song is getting on, but needs more", f:"bold 30px sans-serif", c:"#fa0"}, // orange
        {x:320, y:280, t:"your song brings joy, but still is rough", f:"bold 30px sans-serif", c:"#ffa"}, // yellow
        {x:320, y:280, t:"your song brings fame joy and happiness", f:"bold 30px sans-serif", c:"#0f5"}, // green

        {x:320, y:360, t:"press home to keep exploring", f:"bold 30px sans-serif", c:"#0af"}
      ],
      _startx_: 288,
      _starty_: 450
    },

    ////////////////////////////////////////////////////////////////////////////////////////////////////////
    b01: {
      _title_: "dig up diamonds by the score",
      _map_: [
        [13, 31, 31, 31, 31, 31, 31, 31, 31, 14],
        [22, -2, -2, -2, -2, -2, -2, -2, -2, 20],
        [22, -2, -2, -2,  9, -2,  5, -2, -2, 20],
        [22, 91, 21, 21, 21, 21, 21, 21, 21, 20],
        [22, -2, -2, -2, -2, -2, -2, -2, -2, 20],
        [22, 21, -2, -2, -2, -2, -2, -2, -2, 20],
        [22, 21, 21, -2, -2, -2, -2, -2, -2, 20],
        [22, 21, 21, 21, 91, -2, -2, -2, -2, 20],
        [22, 21, 21, 21, -2, -2, 57, -2, -2, 20],
        [23, 11, 11, 11, 11, 11, 11, 11, 11, 24]
      ],
      _background_: "#068",
      _portals_: { 9: "b02" },
      _message_: "space or right button to jump",
      _startx_: 288,
      _starty_: 512
    },
    b02: {
      //_title_: "",
      _map_: [
        [89, 16, 78, 13, 31, 31, 31, 31, 31, 14],
        [89, 16, 16, 16, -2, -2, -2, -2, -2, 20],
        [-1, 88, 88, 22,  9, -2, -2, -2, -2, 20],
        [-2, -2, -2, 22, 21, 21, 21, 21, -2, 20],
        [-2, -2, -2, 22, -2, -2, -2, -2, -2, 20],
        [-2, -2, -2, 22, -2, -2, 21, 21, 21, 20],
        [-2, -2, -2, 22, 91, 21, 21, 21, 21, 20],
        [-1, 78, -1, 22, -2, 21, 21, 21, 21, 20],
        [89,  5, 79, 22, 91, -2, 57, -2, -2, 20],
        [89, 16, 79, 23, 11, 11, 11, 11, 11, 24]
      ],
      _background_: "#068",
      _portals_: { 9: "b03" },
      _message_: "face wall - double jump",
      _startx_: 288,
      _starty_: 512
    },
    b03: {
      //_title_: "",
      _map_: [
        [13, 31, 31, 31, 31, 31, 31, 32,291, 20],
        [22, -2, -2, -2, -2, -2, -2, -2, -2, 20],
        [22, -2, -2, -2,  9, -2, -2, -2, -2, 20],
        [22, 21, 21, 21, 21, 21, 21, 21, 21, 20],
        [22,  5, -2, -2, -2, -2, -2, -2, -2, 20],
        [22, -2, 88, -2, -2, -2, 21, 21, -2, 20],
        [22, -2, -2, -2, -2, 21, 21, 21, -2, 20],
        [22, -2, -2, -2, 21, 21, 21, 21, -2, 20],
        [22, -2, -2, -2, -2, -2, -2, 21, -2, 20],
        [23, 11, 11, 11, 11, 11, 11, 12,291, 20]
      ],
      _background_: "#068",
      _portals_: { 9: "b04" },
      _startx_: 288,
      _starty_: 512
    },
    b04: {
      //_title_: "",
      _map_: [
        [13, 31, 31, 31, 31, 31, 31, 31, 31, 14],
        [22, -2, -2, -2, -2, -2, -2, -2, -2, 20],
        [22, -2, -2, -2,  9, -2, -2, -2, -2, 20],
        [22, 11, 11, 11, 11, 11, 11, 11, 11, 20],
        [22, -2, 91, -2, -2, -2, -2,  5, -2, 20],
        [22, 11, 11, 11, -2, -2, 11, 11, 11, 20],
        [22, -2, 91, -2, -2, -2, -2, -2, -2, 20],
        [22, -2, 11, 11, -2, -2, 11, 11, -2, 20],
        [22, -2, 91, 57, -2, -2, -2, -2, -2, 20],
        [23, 11, 11, 11, 11, 11, 11, 11, 11, 24]
      ],
      _background_: "#068",
      _portals_: { 9: "b05" },
      _message_: "jump through these",
      _startx_: 288,
      _starty_: 512
    },
    b05: {
      //_title_: "",
      _map_: [
        [13, 31, 31, 31, 31, 31, 31, 31, 31, 14],
        [22,  5, -2, -2, -2, -2, -2, -2, -2, 20],
        [22, -2, -2, -2, -2, -2, -2, -2, -2, 20],
        [22, -2, 88, -2, -2, -2, -2, 88, -2, 20],
        [22, -2, -2, -2,  7,  8, -2, -2, -2, 20],
        [22, -2, 11, 11, 11, 11, 11, 11, -2, 20],
        [22, -2, -2, -2, 57, -2, -2, -2, -2, 20],
        [22, -2, 11, 11, 11, 11, 11, 11, -2, 20],
        [22, -2, -2, -2, -2, -2, -2, -2, -2, 20],
        [23, 11, 11, 11, 11, 11, 11, 11, 11, 24]
      ],
      _background_: "#068",
      _portals_: { 9: "b06" },
      _message_: "up to unlock",
      _startx_: 288,
      _starty_: 512
    },
    b06: {
      //_title_: "",
      _map_: [
        [13, 31, 31, 31, 31, 31, 31, 31, 31, 14],
        [22, -2, -2, -2, -2, -2, -2, -2, -2, 20],
        [22, -2, -2, -2, -2, -2,  8, -2, -2, 20],
        [22, -2, 11, 11, 11, 11, 11, 11, -2, 20],
        [22, -2, -2, -2,  5, -2, -2, -2, -2, 20],
        [22, -2, 11, 11, 11, 11, 11, 11, -2, 20],
        [22, -2, -2, 57, -2, -2, -2, -2, -2, 20],
        [22, -2, 11, 11, 11, 11, 11, 11, -2, 20],
        [22, -2, -2, -2, -2, -2, -2, -2, -2, 20],
        [23, 11, 11, 11, 11, 11, 11, 11, 11, 24]
      ],
      _background_: "#068",
      _enemies_: [
        { b:"a", x: 288, y: 256, l: 268, r: 308, t: 50, d: 5 } // worm
      ],
      _drop_: [
        { x: 3, y: 2, t: 7 }
      ],
      _portals_: { 9: "b07", 109: "b08" },
      _message_: "left button or left alt to sing",
      _startx_: 288,
      _starty_: 512
    },

    b07: {
      //_title_: "",
      _map_: [
        [13, 31, 14, -2, -2, -2, -2, 13, 31, 14],
        [22, -2, 20, 21, -2, -2, 21, 22,  5, 20],
        [22, -2, 20, -2, -2, -2, -2, -2, -2, 20],
        [22, -2, -2, -2, -2, -2, -2, 21, -2, 20],
        [22, -2, 21, -2, -2, 21, 21, 21, -2, 20],
        [22, -2, 21, 21, 21, -2, -2, 21, -2, 20],
        [22, -2, 21, -2, -2, -2, -2, -2, -2, 20],
        [22, -2, -2, -2, -2, -2, -2, 22, -2, 20],
        [22, -2, 20, -2, -2, -2, -2, 22, -2, 20],
        [23, 11, 24, -2, 21, 21, -2, 23, 11, 24]
      ],
      _background_: "#068",
      _enemies_: [
        { b:"a", x: 435, y: 128, f: 1, l: 192, r: 500, t: 40, d: 5 }, //top wasp
        { b:"a", x: 145, y: 448, l: 80, r: 384, t: 40, d: 5 },  //bottom wasp
        { b:"a", x: 360, y: 192, l: 320, r: 384, t: 50, d: 5 } //worm
      ],
      _drop_: [
        { x: 4, y: 4, t: 25 }, // switch
        { x: 4, y: 2, t: 90 }, // dpad up
        { x: 4, y: 3, t: 291 } // arrow down
      ],
      _action_: [
        { l: "b06", x:6, y:8, t:109, m:"back to the new door" },
        { l: "b06", x:5, y:8, t:491 }, // right arrow
        { x: 5, y: 3, t:57 }, // message
        { x: 4, y: 2, t: -1 }, // wipe dpad up
        { x: 4, y: 3, t: -1 } // wipe arrow down
      ],
      _message_: "press the back button",
      _startx_: 288,
      _starty_: 512
    },

    b08: {
      //_title_: "",
      _map_: [
        [22, -2, 30, 31, 14, 13, 31, 32,  5, 20],
        [22, -2, -2, -2, 30, 32, -2, -2, -2, 20],
        [22, -2, -2, -2, -2, -2, -2,  8, -2, 20],
        [22, 11, 11, -2, -2, -2, -2, 11, 11, 20],
        [22, -2, -2, -2, -2, -2, -2, -2, -2, 20],
        [22, -2, 11, 11, 11, 11, 11, 11, -2, 20],
        [22, -2, -2, -2, -2, -2, -2, -2, -2, 20],
        [22, 11, 11, -2, -2, -2, -2, 11, 11, 20],
        [22, -2, -2, -2, -2, -2, -2, -2, -2, 20],
        [22, -2, 10, 11, 11, 11, 11, 12, -2, 20]
      ],
      _background_: "#068",
      _enemies_: [
        { b:"a", x: 435, y: 100, f: 1, l: 390, r: 500, t: 40, d: 5 }, //wasp
        { b:"a", x: 145, y: 100, l: 80, r: 190, t: 40, d: 5 },  //wasp
        { b:"a", x: 288, y: 256, l: 150, r: 426, t: 50, d: 5 } //worm
      ],
      _drop_: [
        { x: 2, y: 2, t: 7 }
      ],
      _portals_: { 9: "b09", 109: "b10" },
      _startx_: 288,
      _starty_: 512
    },

    b09: {
      //_title_: "",
      _map_: [
        [13, 31, 31, 31, 31, 31, 31, 31, 31, 14],
        [22, -2, -2, -2, -2,  5, -2, -2, -2, 20],
        [22, -2, -2, -2, -2, -2, -2, -2, -2, 20],
        [23, 11, 12, -2, -2, -2, -2, 10, 11, 24],
        [-2, -2, 22, -2, -2, -2, -2, 20, -2, -2],
        [-2, -2, 22, -2, 11, 11, -2, 20, -2, -2],
        [13, 31, 32, -2, -2, -2, -2, 30, 31, 14],
        [22, -2, -2, -2, 11, 11, -2, -2, -2, 20],
        [22, -2, -2, -2, -2, -2, -2, -2, -2, 20],
        [23, 11, 11, 11, 11, 11, 11, 11, 11, 24]
      ],
      _background_: "#068",
      _enemies_: [
        { b:"a", x: 128, y: 128, l: 64, r: 128, t: 50, d: 5 }, // worm
        { b:"a", x: 448, y: 128, l: 448, r: 512, t: 50, d: 5 },  // worm

        { b:"b", x: 192, y: 64, f: 1, l: 64, r: 512, t: 40, d: 5 }, //wasp
        { b:"b", x: 384, y: 512, f: 1, l: 64, r: 512, t: 40, d: 5 } //wasp
      ],
      _drop_: [
        { x: 4, y: 6, t: 25 } // switch
      ],
      _action_: [
        { l: "b08", x:8, y:6, t:109, m:"back! back!" },
        { l: "b08", x:7, y:6, t:491 },
        { x:4, y: 3, t:11 },
        { x:5, y: 3, t:11 }
      ],
      _startx_: 288,
      _starty_: 512
    },

    b10: {
      //_title_: "",
      _map_: [
        [13, 32, -2, 30, 31, 31, 32, -2, 30, 14],
        [22, -2, -2, -2, -2, -2, -2, -2, -2, 20],
        [22, -2, 21, -2, -2, -2, -2, 21, -2, 20],
        [22, -2, -2, 21, -2, -2, 21, -2, -2, 20],
        [22, -2, -2, -2, -2, -2, -2, -2, -2, 20],
        [22, -2, -2, -2, 21, 21, -2, -2, -2, 20],
        [22, -2, -2, 21, -2, -2, 21,  8, -2, 20],
        [22, -2, 21, -2, -2, -2, -2, 21, -2, 20],
        [22, -2, -2, -2, -2, -2, -2, -2,  5, 20],
        [23, 12, -2, 10, 11, 11, 12, -2, 10, 24]
      ],
      _background_: "#068",
      _enemies_: [
        { b:"a", x: 435, y: 70, f: 1, l: 390, r: 500, t: 40, d: 5 }, //wasp
        { b:"a", x: 145, y: 70, l: 80, r: 190, t: 40, d: 5 },  //wasp
        { b:"a", x: 435, y: 320, f: 1, l: 390, r: 500, t: 40, d: 5 }, //wasp
        { b:"a", x: 145, y: 320, l: 80, r: 190, t: 40, d: 5 },  //wasp
        { b:"a", x: 288, y: 256, l: 268, r: 308, t: 50, d: 5 } // worm
      ],
      _drop_: [
        { x: 2, y: 1, t: 7 } // key
      ],
      _portals_: { 9: "bbs" },
      _startx_: 288,
      _starty_: 512
    },

    bbs: {
      _title_: "their horrid wings",
      _map_: [
        [13, 31, 31, 31, 31, 31, 31, 31, 31, 14],
        [22, -2, -2, -2, -2, -2, -2, -2, -2, 20],
        [22, -2, -2, -2, -2, -2, -2, -2, -2, 20],
        [22, -2, -2, -2, -2, -2, -2, -2, -2, 20],
        [22, -2, -2, -2, -2, -2, -2, -2, -2, 20],
        [22, -2, 11, -2, -2, -2, -2, 11, -2, 20],
        [22, -2, -2, -2, -2, -2, -2, -2, -2, 20],
        [22, -2, -2, 11, -2, -2, 11, -2, -2, 20],
        [22, -2, -2, -2, -2, -2, -2, -2, -2, 20],
        [23, 11, 11, 11, 11, 11, 11, 11, 11, 24]
      ],
      _background_: "#034",
      _enemies_: [
        { b:"a", x: 145, y: 300, z:2, l: 128, r: 384, t: 40, d: 5, h:5, s: 128, c: 120 } //big wasp
      ],
      _drop_: [
        { x: 2, y: 4, t: 96 }, // blue note
        { x: 4, y: 8, t: 57 }, // message
        { x: 7, y: 4, t: 27 }, // green key
        { l: "s", x: 4, y: 6, t: 291} // down arrow on start screen
      ],
      _message_: "press home to keep exploring",
      _startx_: 288,
      _starty_: 512
    },

    ////////////////////////////////////////////////////////////////////////////////////////////////////////
    r01: { 
      _title_: "hot in here",
      _map_: [
        [34, 34, 34, 34, 34, 34, 34, 34, 34, 34],
        [34, -2, -2, -2, -2, -2, -2, -2, -2, 34],
        [34, -2, -2, -2, 95, 95, -2, -2, -2, 34],
        [34, -2, -2, -2, -2, -2, -2, -2, -2, 34],
        [34, 34, 34, 34, -2, -2, 34, 34, 34, 34],
        [34, -2, -2, -2, -2, -2, -2, -2, -2, 34],
        [34, -2, -2, -2, 95, 95, -2, -2, -2, 34],
        [34, -2, -2, 95,  5, -2, 95, -2, -2, 34],
        [34, -2, -2, -2, 18, -2, -2, -2, -2, 34],
        [34, 34, 34, 34, 34, 34, 34, 34, 34, 34]
      ],
      _background_: "#600",
      _enemies_: [
        { b:"a", x: 64, y: 192, l: 64, r: 192, t: 60, d: 5 }, // blob - top left
        { b:"a", x: 512, y: 192, l: 384, r: 512, t: 60, d: 5 }, // blob - top right
        { b:"a", x: 288, y: 320, l: 256, r: 320, t: 60, d: 5 } // blob - middle
      ],
      _portals_: {19:"r02"},
      _drop_: [
        { x: 5, y: 1, t: 17 }
      ],
      _startx_: 288,
      _starty_: 64
    },

    r02: {
      //_title_: "",
      _map_: [
        [34, -2, 34, 34, 34, 34, 34, 34, 34, 34],
        [34, -2, -2, -2, -2, -2, -2, -2, -2, 34],
        [34, 34, 34, 34, 34, 95, -2, -2, -2, 34],
        [34, -2, -2, -2, -2, -2, -2, -2, -2, 34],
        [34, -2, 34, 34, 34, 34, 34, 34, 34, 34],
        [34, -2, 34, -2, -2, -2, -2, -2, -2, 34],
        [34, -2, 34,  5, -2, -2, -2, -2, -2, 34],
        [34, -2, 34, 34, 34, 34, 95, 95, -2, 34],
        [34, -2, -2, 18, -2, -2, -2, -2,118, 34],
        [34, -2, 34, 34, 34, 34, 34, 34, 34, 34]
      ],
      _background_: "#600",
      _enemies_: [
        { b:"a", x: 320, y: 384, l: 192, r: 448, t: 60, d: 5 }, // blob - bottom
        { b:"a", x: 192, y: 192, l: 64, r: 256, t: 260, d: 5 }, // blob - top
        { b:"b", x: 64, y: 256, f: 1, l: 256, r: 448, t: 80, m: 1, d: 2, z:4 } //bat
      ],
      _drop_: [
        { x: 5, y: 8, t: 17 }
      ],
      _portals_:{19:"r03", 119:"r04"},
      //_action_: [],
      _startx_: 288,
      _starty_: 64
    },
    
    r03: {
      //_title_: "",
      _map_: [
        [34, 34, 34, 34, 34, -2, 34, 34, 34, 34],
        [34,  5, -2, -2, -2, -2, -2, -2, -2, 34],
        [34, -2, -2, -2, 34, 34, -2, -2, -2, 34],
        [34, -2, -2, 34, -2, -2, 34, -2, -2, 34],
        [34, -2, 95, -2, -2, -2, -2, 95, -2, 34],
        [34, -2, -2, -2, -2, -2, -2, -2, -2, 34],
        [34, 34, 34, 34, -2, -2, 34, 34, 34, 34],
        [-2, 34, -2, -2, -2, 95, -2, -2, 34, -2],
        [-2, 34, -2, 18, -2, -2, -2, -2, 34, -2],
        [-2, 34, 34, 34, 34, -2, 34, 34, 34, -2]
      ],
      _background_: "#600",
      _enemies_: [
        { b:"a", x: 288, y: 384, l: 256, r: 320, t: 80, d: 5, z:4 }, // bat - h
        { b:"a", x: 64, y: 128, l: 64, r: 192, t: 80, d: 5, z:4 }, // bat - h
        { b:"a", x: 512, y: 128, l: 384, r: 512, t: 80, d: 5, z:4 } // bat - h

      ],
      _drop_: [
        { x: 6, y: 8, t: 17 }
      ],
      _portals_:{19:"r05"},
      //_action_: [],
      _startx_: 288,
      _starty_: 64
    },

    r04: {
      //_title_: "",
      _map_: [
        [34, -2, 34, 34, 34, 34, 34, 34, -2, 34],
        [34, -2, 34, -2, -2, -2, -2, 34, -2, 34],
        [34, -2, 34, -2, -2, -2, -2, 34, -2, 34],
        [34, -2, 34, -2, 34, 34, -2, 34, -2, 34],
        [34, -2, 34, -2, -2, -2, -2, -2, -2, 34],
        [34, -2, -2, -2, -2, -2, -2, 34, -2, 34],
        [34, -2, 34, -2, 34, 34, -2, 34, -2, 34],
        [34, -2, 34, -2, -2, -2, -2, 34, -2, 34],
        [34,  5, 34, -2, -2, -2, 18, 34, -2, 34],
        [34, -2, 34, 34, 34, 34, 34, 34, -2, 34]
      ],
      _background_: "#600",
      _enemies_: [
        { b:"a", x: 288, y: 320, l: 256, r: 320, t: 60, d: 5 }, // blob

        { b:"b", x: 192, y: 384, l: 64, r: 512, t: 80, d: 5, z:4 }, // bat - v
        { b:"b", x: 384, y: 384, l: 64, r: 512, t: 80, d: 5, z:4 }, // bat - v

        { b:"b", x: 64, y: 512, l: 64, r: 192, t: 80, d: 5, z:4 }, // bat - v
        { b:"b", x: 512, y: 512, l: 64, r: 192, t: 80, d: 5, z:4 } // bat - v        
      ],
      _drop_: [
        { x: 8, y: 8, t: 17 }
      ],
      _portals_:{19:"r06"},
      //_action_: [],
      _startx_: 288,
      _starty_: 128
    },

    r05: {
      //_title_: "",
      _map_: [
        [34,  5, 34, 34, 34, 34, 34, 34, -2, 34],
        [34, -2, 34, -2, -2, -2, -2, -2, -2, 34],
        [34, -2, 34, 34, 34, 34, 34, 34, -2, 34],
        [34, -2, -2, -2, -2, -2, -2, 34, -2, 34],
        [34, 34, 34, -2, 34, 34, -2, 34, -2, 34],
        [34, -2, -2, -2, 34, 34, -2, 34, -2, 34],
        [34, -2, 34, -2, 34, -2, -2, 34, -2, 34],
        [34, -2, 34, -2, 34, -2, 95, 34, 34, 34],
        [34, -2, 34, 18, 34, -2, -2, -2, -2, 34],
        [34, -2, 34, 34, 34, 34, 34, 34, -2, 34]
      ],
      _background_: "#600",
      _enemies_: [
        { b:"a", x: 288, y: 192, l: 256, r: 320, t: 60, d: 5 }, // blob
 
        { b:"b", x: 64, y: 512, l: 64, r: 512, t: 80, d: 5, z:4 }, // bat - v  
        { b:"b", x: 192, y: 256, l: 64, r: 512, t: 80, d: 5, z:4 }, // bat - v  
        { b:"b", x: 384, y: 384, l: 64, r: 512, t: 80, d: 5, z:4 } // bat - v  
      ],
      _drop_: [
        { x: 5, y: 8, t: 17 }
      ],
      _portals_:{19:"r07"},
      //_action_: [],
      _startx_: 288,
      _starty_: 64
    },

    r06: {
      //_title_: "",
      _map_: [
        [34, 34, 34, 34, 34, 34, 34, 34, -2, 34],
        [34, -2, -2, -2, -2, -2, -2,  5, -2, 34],
        [34, 34, 34, -2, -2, -2, -2, 34, 34, 34],
        [34, -2, -2, -2, -2, -2, -2, -2, -2, 34],
        [34, -2, -2, 34, 34, 34, 34, -2, -2, 34],
        [34, -2, -2, -2, -2, -2, -2, -2, -2, 34],
        [34, -2, -2, -2, -2, -2, -2, -2, 34, 34],
        [34, -2, 95, -2, -2, -2, -2, 95, -2, 34],
        [34, -2, -2, -2, -2, -2, -2, 18, -2, 34],
        [34, 34, 34, 34, 34, 34, 34, 34, -2, 34]
      ],
      _background_: "#600",
      _enemies_: [
        { b:"a", x: 288, y: 192, l: 192, r: 384, t: 60, d: 5 }, // blob
        { b:"a", x: 64, y: 512, l: 64, r: 448, t: 60, d: 5, z:4 }, // blob

        { b:"b", x: 192, y: 384, l: 320, r: 512, t: 80, d: 5, z:4 }, // bat - v
        { b:"b", x: 384, y: 384, l: 320, r: 512, t: 80, d: 5, z:4 }, // bat - v

        { b:"a", x: 64, y: 448, l: 64, r: 512, t: 80, d: 5, z:4 } // bat - h
      ],
      _drop_: [
        { x: 5, y: 8, t: 17 }
      ],
      _portals_:{19:"r08"},
      //_action_: [],
      _startx_: 64,
      _starty_: 64
    },

    r07: {
      //_title_: "",
      _map_: [
        [34, 34, 34, 34, 34, 34, 34, -2, 34, -2],
        [34, -2, -2, -2, -2, -2, -2, -2, 34, -2],
        [34, -2, -2, -2, 34, 34, 34, 34, 34, -2],
        [34, -2, -2, -2, -2, -2, -2, -2, 34, 34],
        [34, -2, -2, -2, -2, -2, -2, -2, -2, 34],
        [34, -2, -2, -2, -2, -2, -2, -2, -2, 34],
        [34, 34, -2, -2, -2, -2, -2, -2, -2, 34],
        [-2, 34, -2, -2, -2, -2, -2, -2,  5, 34],
        [-2, 34, 34, 18, -2, -2, -2, -2, 34, 34],
        [-2, -2, 34, 34, 34, 34, 34, -2, 34, -2]
      ],
      _background_: "#600",
      _enemies_: [
        { b:"a", x: 288, y: 512, l: 192, r: 384, t: 60, d: 5 }, // blob

        { b:"b", x: 192, y: 384, l: 64, r: 512, t: 80, d: 5, z:4 }, // bat - v
        { b:"b", x: 384, y: 384, l: 192, r: 512, t: 80, d: 5, z:4 }, // bat - v

        { b:"b", x: 64, y: 512, l: 64, r: 320, t: 80, d: 5, z:4 }, // bat - v
        { b:"b", x: 512, y: 512, l: 256, r: 448, t: 80, d: 5, z:4 } // bat - v 
      ],
      _drop_: [
        { x: 4, y: 1, t: 17 }
      ],
      _portals_:{19:"r09"},
      //_action_: [],
      _startx_: 448,
      _starty_: 64
    },

    r08: {
      //_title_: "",
      _map_: [
        [34, 34, 34, 34, 34, 34, 34, 34, 34, 34],
        [34,  5, -2, -2, -2, -2, -2, -2, -2, 34],
        [34, -2, -2, -2, 95, 95, -2, -2, -2, 34],
        [34, -2, -2, 34, -2, -2, 34, -2, -2, 34],
        [34, -2, -2, -2, -2, -2, -2, -2, -2, 34],
        [34, -2, 95, -2, -2, -2, -2, 95, -2, 34],
        [34, -2, -2, -2, 34, 34, -2, -2, -2, 34],
        [34, -2, 95, -2, -2, -2, -2, 95, -2, 34],
        [34, -2, -2, -2, -2, -2, 18, -2, -2, 34],
        [34, 34, 34, 34, 34, 34, 34, 34, 34, 34]
      ],
      _background_: "#600",
      _enemies_: [
        { b:"a", x: 64, y: 64, l: 64, r: 512, t: 260, d: 5 }, // blob

        { b:"b", x: 64, y: 128, l: 96, r: 512, t: 80, d: 5, z:4 }, // bat - v
        { b:"b", x: 512, y: 384, l: 96, r: 512, t: 80, d: 5, z:4 }, // bat - v

        { b:"a", x: 64, y: 256, l: 64, r: 512, t: 80, d: 5, z:4 } // bat - h
      ],
      _drop_: [
        { x: 7, y: 6, t: 17 }
      ],
      _portals_:{19:"r10"},
      //_action_: [],
      _startx_: 288,
      _starty_: 64
    },

    r09: {
      //_title_: "",
      _map_: [
        [-2, 34, 34, 34, -2, -2, 34, 34, 34, -2],
        [-2, 34, -2, -2, -2, -2, -2, -2, 34, -2],
        [-2, 34, -2, 34, 34, 34, 34, -2, 34, -2],
        [34, 34, 95, 34, -2, -2, 34, 95, 34, 34],
        [34, -2, -2, -2, -2, -2, -2,  5, -2, 34],
        [34, -2, 95, -2, -2, -2, -2, 95, -2, 34],
        [34, -2, -2, -2, -2, -2, -2, -2, -2, 34],
        [34, 95, -2, -2, -2, -2, -2, -2, 95, 34],
        [34, -2, -2, -2, -2, -2, -2, -2, -2, 34],
        [34, 34, 34, 34, 95, 95, 34, 34, 34, 34]
      ],
      _background_: "#600",
      _enemies_: [
        { b:"a", x: 64, y: 512, l: 64, r: 512, t: 60, d: 5, z:4 }, // blob

        { b:"b", x: 192, y: 384, l: 320, r: 512, t: 80, d: 5, z:4 }, // bat - v
        { b:"b", x: 384, y: 384, l: 320, r: 512, t: 80, d: 5, z:4 }, // bat - v

        { b:"a", x: 64, y: 256, l: 64, r: 512, t: 80, d: 5, z:2 } // bat - h
      ],
      _drop_: [
        { x: 4, y: 1, t: 25 }, // switch
        { x: 5, y: 1, t: 17 } // key
      ],
      //_portals_:{},
      _action_: [ 
        { l:"r10",  x: 4, y: 8, t: 18  } // door
      ],
      _startx_: 288,
      _starty_: 64
    },

    r10: {
      //_title_: "",
      _map_: [
        [34, -2, 34, 34, 34, 34, 34, 34, -2, 34],
        [34, -2, 34, -2, -2, -2, -2, 34, -2, 34],
        [34, -2, 34, -2, 34, 34, -2, 34, -2, 34],
        [34, -2, -2, -2, -2, -2, -2, -2, -2, 34],
        [34, -2, -2, -2, -2, -2, -2, -2, -2, 34],
        [34, -2, -2, -2, -2, -2, -2, -2, -2, 34],
        [34, -2, 34, 34, 34, 34, 34, 34, -2, 34],
        [34, -2, -2, -2, -2, -2, -2, -2, -2, 34],
        [34, -2, 34, -2, -2, -2, -2, 34, -2, 34],
        [34,  5, 34, 34, 34, 34, 34, 34, -2, 34]
      ],
      _background_: "#600",
      _enemies_: [
        { b:"a", x: 288, y: 448, l: 128, r: 448, t: 260, d: 5 }, // blob

        { b:"b", x: 64, y: 0, l: 64, r: 256, t: 80, d: 5, z:2 }, // bat - v
        { b:"b", x: 512, y: 0, l: 64, r: 256, t: 80, d: 5, z:2 }, // bat - v

        { b:"a", x: 64, y: 256, l: 64, r: 512, t: 80, d: 5, z:2 }, // bat - h

        { b:"b", x: 64, y: 576, l: 256, r: 512, t: 80, d: 5, z:2 }, // bat - v
        { b:"b", x: 512, y: 576, l: 256, r: 512, t: 80, d: 5, z:2 } // bat - v
      ],
      _drop_: [
        { x: 5, y: 8, t: 17 }
      ],
      _portals_:{19:"rbs"},
      //_action_: [],
      _startx_: 288,
      _starty_: 64
    },

    rbs: {
      _title_: "bat out of hell",
      _map_: [
        [34, 34, 34, 34, 34, 34, 34, 34, 34, 34],
        [34, -2, -2, -2, -2, -2, -2, -2, -2, 34],
        [34, -2, -2, -2, 34, 34, -2, -2, -2, 34],
        [34, -2, -2, -2, -2, -2, -2, -2, -2, 34],
        [34, -2, 34, -2, -2, -2, -2, 34, -2, 34],
        [34, -2, -2, 34, -2, -2, 34, -2, -2, 34],
        [34, -2, -2, -2, -2, -2, -2, -2, -2, 34],
        [34, -2, -2, -2, 34, 34, -2, -2, -2, 34],
        [34, -2, -2, -2, -2, -2, -2, -2, -2, 34],
        [34, 34, 34, 34, 34, 34, 34, 34, 34, 34]
      ],
      _background_: "#300",
      _enemies_: [
        { b:"a", x: 288, y: 330, f: 1, l: 128, r: 384, t: 80, m: 1, d: 2, z:4, h:7, s:128, c:120 } //big bat
      ],
      _drop_: [
        { x: 2, y: 2, t: 97 }, // red note
        { x: 7, y: 2, t: 37 }, // yellow key
        { l: "s", x: 6, y: 6, t: 291} // down arrow on start screen
      ],
      _startx_: 288,
      _starty_: 64
    },

    ////////////////////////////////////////////////////////////////////////////////////////////////////////
    g01: {
      _title_: "those useless trees",
      _map_: [
        [58, 58, 58, 58, 58, 58, 58, 58, 58, 58],
        [59, -2, 77, -2, -2, -2, 77, -2,  5, 59],
        [59, -2, 77, -2, -2, -2, 77, -2, -2, 59],
        [59, -2, 94, 69, 69, 69, 94, -2, -2, 59],
        [59, -2, 77, -2, -2, -2, 77, 28, -2, 59],
        [59, -2, 77, -2, 69, 69, 94, 69, 69, 59],
        [59, -2, 77, -2, -2, -2, 77, -2, -2, 59],
        [59, 69, 94, -2, -2, -2, 77, -2, 69, 59],
        [59, -2, 77, -2, -2, -2, 77, -2, -2, 59],
        [59, 69, 69, 69, 69, 69, 94, 69, 69, 59]
      ],
      _background_: "#060",
      _enemies_:[
         { b:"a", x: 288, y: 128, l: 128, r: 384, t: 42, m: 1, d: 15 }, //frog
         { b:"a", x: 288, y: 256, f: 1, l: 256, r: 512, t: 42, m: 1, d: 15 }, //frog
         { b:"a", x: 400, y: 384, f: 1, l: 128, r: 448, t: 40, d: 5 } //wasp
      ],
      _portals_:{29:"g02"},
      _drop_: [
        { x: 3, y: 2, t: 27 }
      ],
      _startx_: 288,
      _starty_: 512
    },

    g02: {
      //_title_: "",
      _map_: [
        [58, 58, 58,  5, 58, 58, 58, 58, 58, 58],
        [59, -2, -2, -2, -2, -2, 77, -2, -2, 59],
        [59, -2, -2, -2, -2, -2, 77, -2, -2, 59],
        [59, -2, -2, 69, 69, 69, 94, 69, 69, 59],
        [59, -2, -2, -2, -2, -2, 77, -2, -2, 59],
        [59, 69, 69, 69, 58, -2, 77, 69, 69, 59],
        [59, -2, -2, -2, 59, -2, 77, -2, -2, 59],
        [59, -2, 58, -2, 59, -2, 94, 69, 69, 59],
        [59, 28, 59, -2, 59, -2, 77, -2,128, 59],
        [59, 69, 59, -2, 59, 69, 94, 69, 69, 59]
      ],
      _background_: "#060",
      _enemies_:[
        { b:"b", x: 192, y: 80, l: 10, r: 500, t: 62, d: 5, z:3 }, // spider
        { b:"a", x: 288, y: 128, l: 192, r: 384, t: 42, m: 1, d: 15 } //frog
      ],
      _portals_:{29:"g03", 129:"g04"},
      _drop_: [
        { x: 8, y: 2, t: 27 }
      ],
      _startx_: 320,
      _starty_: 512
    },

    g03: {
      //_title_: "",
      _map_: [
        [59, -2, 59, 58, 58, 58, 58, 59, -2, 59],
        [59, -2, 59, -2, -2, -2, -2, 59, -2, 59],
        [59, -2, 59, -2, -2, -2, -2, 59, -2, 59],
        [59, -2, 58, -2, -2, -2, -2, 58, -2, 59],
        [59, -2, 77, -2, -2, -2, -2, 77, -2, 59],
        [59, -2, 94, 58, 69, -2, 58, 94, -2, 59],
        [59, 28, 77, 59, -2, -2, 59, 77,  5, 59],
        [59, 69, 77, 59, -2, 69, 59, 77, 69, 59],
        [59, -2, 77, 59, -2, -2, 59, 77, -2, 59],
        [59, -2, 94, 59, 69, 69, 59, 94, -2, 59]
      ],
      _background_: "#060",
      _enemies_: [
        { b:"b", x: 64, y: 90, l: 10, r: 500, t: 62, d: 5, z:3 }, // spider
        { b:"b", x: 288, y: 90, l: 10, r: 400, t: 62, d: 5, z:3 }, // spider
        { b:"b", x: 512, y: 90, l: 10, r: 500, t: 62, d: 5, z:3 }, // spider
        { b:"a", x: 200, y: 256, l: 128, r: 256, t: 42, m: 1, d: 15, z:4 } //frog
      ],
      _drop_: [
        { x: 1, y: 8, t: 27 }
      ],
      _portals_:{29:"g05"},
      _startx_: 288,
      _starty_: 512
    },

    g04: {
      //_title_: "",
      _map_: [
        [59, 58, 58, 58, 58, 58, 58, 58, 58, 59],
        [59, -2, 77, -2, -2, -2, -2, 77, -2, 59],
        [59, -2, 77, -2, -2, -2, -2, 77, -2, 59],
        [59, 58, 94, 69, 69, -2, -2, 77, 58, 59],
        [59, 59, 77, -2, -2, -2, -2, 77, 59, 59],
        [59, 59, 58, -2, -2, -2, -2, 58, 59, 59],
        [59, 59, 59, -2, -2,  5, -2, 59, 59, 59],
        [59, 59, 59, 69, -2, -2, 69, 59, 59, 59],
        [59, 59, 59, -2, -2, -2, -2, 59, 59, 59],
        [59, 59, 94, 69, 69, 69, 69, 94, 59, 59]
      ],
      _background_: "#060",
      _enemies_: [
        { b:"a", x: 64, y: 128, l: 64, r: 256, t: 42, m: 1, d: 15, z:3 }, //frog

        { b:"b", x: 128, y: 90, l: 32, r: 256, t: 62, d: 5, z:2 }, // spider
        { b:"b", x: 288, y: 90, l: 32, r: 500, t: 62, d: 5, z:4 }, // spider
        { b:"b", x: 448, y: 90, l: 32, r: 256, t: 62, d: 5, z:2 } // spider
      ],
      _drop_: [
        { x: 3, y: 8, t: 27 }
      ],
      _startx_: 288,
      _starty_: 512
    },

    g05: {
      //_title_: "",
      _map_: [
        [59, 58, 58, 58, 58, 58, 58, -2, 58, 58],
        [59, 58, -2, -2, 58, 58, -2, -2, -2, 59],
        [59, 58, 58, -2, 77, -2, -2, 58, -2, 58],
        [58, 58, -2, -2, 58, -2, 58, 58, 58, 58],
        [59, 58, 58, -2, 58, 58, 58, 58, 58, 58],
        [58, 58, -2, 69, 58, 58, -2, -2, -2, 59],
        [59, -2, -2, -2, 77, -2,  5, -2, -2, 59],
        [59, 69, 69, -2, 77, -2, -2, -2, -2, 59],
        [59, 28, -2, -2, 77, -2, -2, -2,128, 59],
        [59, 94, 69, 69, 94, 69, 94, -2, 94, 59]
      ],
      _background_: "#060",
      _enemies_: [

        { b:"b", x: 128, y: 90, l: 32, r: 256, t: 62, d: 5, z:2 }, // spider
        { b:"c", x: 288, y: 90, l: 32, r: 400, t: 62, d: 5, z:4 }, // spider
        { b:"b", x: 448, y: 90, l: 32, r: 256, t: 62, d: 5, z:2 } // spider
      ],
      _drop_: [
        { x: 3, y: 8, t: 27 }
      ],
      _portals_:{29:"g06", 129: "g07"},
      _startx_: 288,
      _starty_: 512
    },

    g06: {
      //_title_: "",
      _map_: [
        [59, 58, 58, 58, 59, -2, 58, 58, 58, 59],
        [59, 58, 58, 58, 58, -2, -2, 77, 58, 59],
        [59,  5, 58, 58, 59, -2, 58, 77, -2, 59],
        [59, -2, -2, 58, 59, -2, 59, 94, -2, 59],
        [59, 58, -2, -2, 59, -2, 59, 77, -2, 59],
        [59, -2, -2, -2, -2, -2, 59, 77, -2, 59],
        [59, -2, -2, -2, 59, -2, 59, 94, -2, 59],
        [59, 69, -2, 69, 59, -2, 59, 77, -2, 59],
        [59, 28, -2, -2, 59, -2, 59, 77, -2, 59],
        [59, 69, 69, 69, 59, -2, 59, 94, 69, 59]
      ],
      _background_: "#060",
      _enemies_: [
        { b:"b", x: 128, y: 80, l: -54, r: 630, t: 62, d: 5 }, // spider
        { b:"b", x: 320, y: 80, l: -54, r: 630, t: 62, d: 5, z:5 }, // spider
        { b:"b", x: 512, y: 80, l: -54, r: 630, t: 62, d: 5} // spider
      ],
      _drop_: [
        { x: 3, y: 8, t: 27 }
      ],
      _portals_:{29:"g08"},
      _startx_: 128,
      _starty_: 512
    },

    g07: {
      //_title_: "",
      _map_: [
        [58, 58, -2, 58, 58, 58, 58, 58, 77, 58],
        [58, 58, -2, 77, -2, 58, 58, -2, 77, 58],
        [58, 58, 58, 58, -2, 58, 77, -2, 58, 58],
        [58, 58, 58, 77, -2, -2, 77, 58, 58, 58],
        [58, 58, 58, 58, 58, 58, 58, 58, 58, 58],
        [58, 58, -2, 77, -2, -2, 58, 58, 58, 58],
        [58, 77, -2, 58, 58, -2, 77,  5, 58, 58],
        [58, 77, 58, 58, 58, -2, 58, 28, 77, 58],
        [58, 77, -2, 58, -2, -2, 58, 58, 77, 58],
        [58, 58, -2, 58, 58, 58, 58, 58, 77, 58]
      ],
      _background_: "#060",
      _enemies_: [
        { b:"c", x: 192, y: 80, l: 10, r: 500, t: 62, d: 5, z:3 }, // c-spider
        { b:"c", x: 500, y: 400, l: 10, r: 500, t: 62, d: 5, z:4 }, // c-spider
        { b:"c", x: 192, y: 193, l: 10, r: 500, t: 62, d: 5, z:5 } // c-spider
      ],
      _drop_: [
        { x: 4, y: 2, t: 27 }
      ],
      _portals_:{29:"g09"},
      _startx_: 288,
      _starty_: 512
    },

    g08: {
      //_title_: "",
      _map_: [
        [58, 58, 58, 58, 58, 58, 58, 58, 58, 59],
        [58, 58, 58, 58, 58, 58, 58, 58, 58, 59],
        [58, 58, -2, 77, -2, 58, 58, 58, 77, 59],
        [58, -2, -2, 77, -2, 77, 58, -2, 77, 59],
        [59, 94, -2, 77, -2, 77, -2, -2, 77, 59],
        [59, 77, 94, 77, -2, 77, -2, -2, 94, 59],
        [59, 77, 77, 77, -2, 77,  5, -2, 77, 59],
        [59, 77, 77, 94, -2, 77, -2, 94, 77, 59],
        [59, 77, 77, 77, -2, 77, -2, 77, 77, 59],
        [59, 94, 94, 94, 94, 94, 94, 94, 94, 59]
      ],
      _background_: "#060",
      _enemies_: [
        { b:"c", x: 192, y: 80, l: 10, r: 500, t: 62, d: 5, z:3 }, // c-spider
        { b:"c", x: 500, y: 400, l: 10, r: 500, t: 62, d: 5, z:6 }, // c-spider
        { b:"c", x: 192, y: 193, l: 10, r: 500, t: 62, d: 5, z:5 }, // c-spider
        { b:"c", x: 400, y: 512, l: 10, r: 500, t: 62, d: 5, z:2 } // c-spider

      ],
      _drop_: [
        { x: 2, y: 4, t: 27 }
      ],
      _portals_:{29:"g10"},
      _startx_: 288,
      _starty_: 512
    },

    g09: {
      //_title_: "",
      _map_: [
        [58, 58, 58, 58, 58, 58, 58, 58, -2, 58],
        [58, 58, 58, 77, 58, -2, 77,  5, -2, 58],
        [59, 58, -2, 77, -2, -2, 77, -2, -2, 59],
        [59, 69, 69, 94, 69, 69, 94, 69, 69, 59],
        [59, -2, -2, 77, -2, -2, 77, -2, -2, 59],
        [59, 69, 69, 94, 69, 69, 94, 69, 69, 59],
        [59, -2, -2, 77, -2, -2, 77, -2, -2, 59],
        [59, 69, 69, 94, 69, 69, 94, 69, 69, 59],
        [59, -2, -2, 77, -2, -2, 77, -2, -2, 59],
        [59, 69, 69, 94, 69, 94, 94, 69, -2, 59]
      ],
      _background_: "#060",
      _enemies_: [
        { b:"a", x: 288, y: 128, l: 128, r: 512, t: 42, m: 1, d: 15 }, //frog
        { b:"a", x: 288, y: 256, f: 1, l: 192, r: 512, t: 42, m: 1, d: 15 }, //frog
        { b:"a", x: 288, y: 384, l: 64, r: 512, t: 42, m: 1, d: 15 }, //frog
        { b:"a", x: 288, y: 512, f: 1, l: 64, r: 448, t: 42, m: 1, d: 15 } //frog
      ],
      _drop_: [
        { x: 2, y: 8, t: 27 },
        { x: 7, y: 8, t: 25 } // switch
      ],
      _action_: [ 
        { l:"g08",  x: 1, y: 8, t: 28  } // door
      ],
      _portals_:{29:"g10"},
      _startx_: 64,
      _starty_: 512
    },

    g10: {
      //_title_: "",
      _map_: [
        [58, 58, 58, 58, 58, 58, 58, 58, 58, 58],
        [58, 58, 77, 58, 77, 58, 58, -2, 58, 58],
        [59, -2, 77, -2, 77, -2, 77, -2, -2, 59],
        [59, -2, 77, -2, 94, 69, 94, -2, -2, 59],
        [59, -2, 77, -2, 77,  5, 77, -2, -2, 59],
        [59, -2, 94, 69, 94, -2, 94, 69, -2, 59],
        [59, -2, 77, -2, 77, -2, 77, -2, -2, 59],
        [59, -2, 77, -2, 94, 69, 94, -2, -2, 59],
        [59, -2, 77, -2, 77, 28, 77, -2, -2, 59],
        [59, 69, 94, 69, 69, 69, 69, 69, 69, 59]
      ],
      _background_: "#060",
      _enemies_: [
        { b:"c", x: 192, y: 80, l: 54, r: 522, t: 62, d: 5, z:10 }, // c-spider
        { b:"c", x: 500, y: 400, l: 54, r: 522, t: 62, d: 5, z:10 }, // c-spider

        { b:"a", x: 288, y: 128, l: 256, r: 384, t: 42, m: 1, d: 15, z:3 }, //frog

        { b:"a", x: 288, y: 256, f: 1, l: 128, r: 256, t: 42, m: 1, d: 15, z:2 }, //frog
        { b:"a", x: 416, y: 256, f: 1, l: 384, r: 448, t: 42, m: 1, d: 15 }, //frog

        { b:"a", x: 288, y: 384, l: 256, r: 384, t: 42, m: 1, d: 15, z:3 } //frog

      ],
      _drop_: [
        { x: 7, y: 1, t: 27 }
      ],
      _portals_:{29:"gbs"},
      _startx_: 288,
      _starty_: 512
    },

    gbs: {
      _title_: "incy wincy spider",
      _map_: [
        [58, 58, 58, 58, 58, 58, 58, 58, 58, 58],
        [59, -2, -2, -2, -2, -2, -2, -2, -2, 59],
        [59, -2, -2, -2, -2, -2, -2, -2, -2, 59],
        [59, 69, 69, 69, -2, -2, 69, 69, 69, 59],
        [59, -2, -2, -2, -2, -2, -2, -2, -2, 59],
        [59, 69, 69, -2, -2, -2, -2, 69, 69, 59],
        [59, -2, -2, -2, -2, -2, -2, -2, -2, 59],
        [59, 69, -2, -2, -2, -2, -2, -2, 69, 59],
        [59, -2, -2, -2, -2, -2, -2, -2, -2, 59],
        [59, 69, 69, 69, 69, 69, 69, 69, 69, 59]
      ],
      _background_: "#030",
      _enemies_: [
        { b:"c", x: 288, y: 64, l: 64, r: 448, a:64, t: 62, d: 5, z:3, h:6, s:128, c:120 } // spider
      ],
      _drop_: [
        { x: 3, y: 2, t: 98 }, // green note
        { x: 6, y: 2, t: 17 }, // red key
        { l: "s", x: 5, y: 6, t: 291} // down arrow on start screen
      ],
      _startx_: 288,
      _starty_: 512
    },


    
    ////////////////////////////////////////////////////////////////////////////////////////////////////////
    y01: {
      _title_: "the house of fun",
      _map_: [
        [64, 65, 65, 65, 65, 65, 65, 65, 65, 66],
        [74, -1, -1, -1, -1, -1, -1, -1, -1, 76],
        [74, -1, -1, -1, -1, -1, -1, -1, -1, 76],
        [74, -1, 75, 75, -1, -1, 75, 75, -1, 76],
        [74, -1, -1, -1, -1, -1, -1, -1, -1, 76],
        [74, -1, -1, -1, 75, 75, -1, -1, -1, 76],
        [74, -1, -1, -1, -1, -1, -1,  5, -1, 76],
        [74, -1, 75, 75, 75, 75, 75, 75, -1, 76],
        [74, -1, -1, -1, 38, -1, -1, -1, -1, 76],
        [84, 85, 85, 85, 85, 85, 85, 85, 85, 86]
      ],
      _background_: "#860",
      _enemies_: [
        { b:"a", x: 435, y: 128, f: 1, l: 128, r: 448, t: 40, d: 5 }, //wasp
        { b:"a", x: 320, y: 384, l: 128, r: 448, t: 52, m: 1, d: 25, z:8 }, //snail    
        { b:"c", x: 64, y: 90, f:1, l: 32, r: 546, t: 62, d: 5, z:10 }, // c-spider    
        { b:"c", x: 512, y: 90, l: 32, r: 546, t: 62, d: 5, z:10 } // c-spider      
      ],
      _drop_: [
        { x: 2, y: 2, t: 37 }
      ],
      _portals_:{39:"y02"},
      _startx_: 288,
      _starty_: 512
    },

    y02: {
      //_title_: "",
      _map_: [
        [64, 65, 75, -2, 75, 65, 65, 65, 65, 66],
        [74, -1, -1, -1, -1, -1, -1, -1, -1, 76],
        [74, -1, 75, -1, -2, -1, -1, 11, -2, 10],
        [74, -1, -1, 75, -1, -2, 11, -1, -2, 20],
        [74, -1, -1, -1, -2, -1, -2, -2, -2, 20],
        [74, -1, 75, -1, -1, -2, -1, 11, -2, 20],
        [74, -1, -1, -1, -1, -1, -1,  5, -2, 20],
        [74, -1, 75, 75, 75, 75, 75, 75, -2, 20],
        [74, -1, -1, -1, 38, -2, -2, -2, -2, 20],
        [84, 85, 75, -1, 10, 11, 11, 11, 11, 24]
      ],
      _background_: "#860",
      _enemies_: [     
        { b:"a", x: 288, y: 340, f: 1, l: 96, r: 480, t: 80, m: 1, d: 2, z:6 }, //bat
        { b:"a", x: 435, y: 64, f: 1, l: 128, r: 448, t: 40, d: 5, z:10 }, //wasp   
        { b:"a", x: 360, y: 512, l: 128, r: 448, t: 260, d: 5, z:8 } // blob 
      ],
      _drop_: [
        { x: 8, y: 1, t: 37 }
      ],
      _portals_:{39:"y03"},
      _startx_: 288,
      _starty_: 512
    },

    y03: {
      //_title_: "",
      _map_: [
        [74, -2, 34, 34, 75, 34, 34, 34, -1, 76],
        [74, -2, -2, 34, -2, -2, -1, -1, -1, 76],
        [74, 83, -2, 34, 34, -1, -1, -1, 75, 76],
        [74, -2, -1, -2, 34, 34, 75, 34, 75, 76],
        [74, -2,  5, -1, -1, -2, -1, -1, -1, 76],
        [74, 83, 75, -2, -2, -2, -1, -1, -1, 76],
        [74, -2, -2, -2, -1, -1, -1, -2, -1, 76],
        [74, -1, -1, 34, 34, 75, -1, -1, -1, 76],
        [74, -1, 38, -2, 75, -1, -1,138, -1, 76],
        [74, -2, 75, 34, 34, 34, 34, 34, -1, 76]
      ],
      _background_: "#860",
      _enemies_: [       
        { b:"a", x: 435, y: 64, f: 1, l: 320, r: 448, t: 40, d: 5 }, //wasp
        { b:"a", x: 90, y: 512, l: 128, r: 192, t: 50, d: 5 }, //worm
        { b:"a", x: 450, y: 515, l:320, r: 448, t: 42, m: 1, d: 15, z:3 }, //frog
        { b:"a", x: 320, y: 256, l: 256, r: 448, t: 252, m: 1, d: 25, z:8 }, //snail       
        { b:"c", x: 64, y: 200, l: 32, r: 546, t: 62, d: 5, z:10 }, // c-spider    
        { b:"c", x: 512, y: 400, l: 32, r: 546, t: 62, d: 5, z:10 } // c-spider
      ],
      _drop_: [
        { x: 5, y: 8, t: 37 }
      ],
      _portals_:{39:"y04", 139:"y05"},
      _startx_: 320,
      _starty_: 128
    },

    y04: {
      //_title_: "",
      _map_: [
        [64, 65, 65, 65, 65, 65, 65, 65, 65, 66],
        [74,  5, -1, -1, -1, -1, -1, -1, -1, 76],
        [74, -1, -1, -1, -2, -2, -1, -1, -2, 76],
        [74, -2, -1, 69, 69, 59, 69, 69, -1, 76],
        [74, -1, -1, -1, -1, 59, -1, -1, -1, 76],
        [74, -2, -1, -2, 69, 59, 69, -2, -1, 76],
        [74, -2, -2, -1, -1, 59, -1, -1, -1, 76],
        [74, -2, 11, -1, -1, 59, -2, -2, 11, 76],
        [74, -2, 38, -2, -2, 59, -2, -2, -2, 76],
        [84, 85, 85, 85, 85, 59, 85, 85, 85, 86]
      ],
      _background_: "#860",
      _enemies_: [
        { b:"c", x:400, y: 128, f: 1, l: 64, r: 512, t: 80, m: 1, d: 2, z:2 }, //c-bat
        { b:"c", x:400, y: 192, f: 1, l: 64, r: 512, t: 80, m: 1, d: 2, z:3 }, //c-bat
        { b:"c", x:400, y: 256, f: 1, l: 64, r: 512, t: 80, m: 1, d: 2, z:4 }, //c-bat
        { b:"c", x:400, y: 384, f: 1, l: 64, r: 512, t: 80, m: 1, d: 2, z:4 }, //c-bat
        { b:"c", x:400, y: 448, f: 1, l: 64, r: 512, t: 80, m: 1, d: 2, z:3 }, //c-bat
        { b:"c", x:400, y: 512, f: 1, l: 64, r: 512, t: 80, m: 1, d: 2, z:2 }, //c-bat   
        { b:"a", x: 320, y: 128, l: 192, r: 448, t: 52, m: 1, d: 25, z:8 }, //snail
        { b:"a", x: 288, y: 256, l: 256, r: 384, t: 60, d: 5 } // blob     
      ],
      _drop_: [
        { x: 8, y: 8, t: 37 }
      ],
      _portals_:{39:"y06"},
      _startx_: 512,
      _starty_: 512
    },

    y05: {
      //_title_: "",
      _map_: [
        [64, 65, 65, 59, 65, 65, 65, 65, 65, 66],
        [74, -1, -2, 59, -2, -1, -1, -1,  5, 76],
        [74, -2, 69, 59, 69, -2, -1, -1, -2, 76],
        [74, -1, -2, 59, -2, -1, -1, -2, -2, 76],
        [74, -2, 69, 59, 69, -2, 95, 69, 69, 76],
        [74, -1, -2, 34, -2, -1, -1, -1, -2, 76],
        [74, -1, -2, 34, -2, 34, 34, -1, -2, 76],
        [74, -1, -2, -2, -2, -1, -1, 34, -2, 76],
        [74, -2, -2, 34, -2, -2, -1, 38, -2, 76],
        [84, 85, 85, 34, 85, 85, 34, 34, 34, 86]
      ],
      _background_: "#860",
      _enemies_: [
        { b:"a", x: 200, y: 64, f: 1, l: 64, r: 512, t: 40, d: 5, z:6 }, //wasp
        { b:"a", x: 200, y: 192, f: 1, l: 64, r: 512, t: 40, d: 5, z:6 }, //wasp
        { b:"a", x: 200, y: 320, f: 1, l: 64, r: 512, t: 40, d: 5, z:6 }, //wasp
        { b:"a", x: 200, y: 448, f: 1, l: 64, r: 384, t: 40, d: 5, z:6 }, //wasp       
        { b:"b", x: 128, y: -50, l: -60, r: 512, t: 62, d: 5, z:8 }, // spider
        { b:"b", x: 192, y: -60, l: -60, r: 502, t: 62, d: 5, z:8 }, // spider    
        { b:"b", x: 256, y: -50, l: -60, r: 512, t: 62, d: 5, z:8 } // spider
       ],
      _drop_: [
        { x: 2, y: 8, t: 37 }
      ],
      _portals_:{39:"y07"},
      _startx_: 288,
      _starty_: 512
    },

    y06: {
      //_title_: "",
      _map_: [
        [64, 65, 65, 65, 65, 65, 65, 65, 65, 66],
        [74, -1, -1, -1, 77, -2, -2, -1, -1, 76],
        [74, -1, 11, -1, 94, 69, 83, -1, 11, 76],
        [74, -1, -1, -1, 77, -2, -1, -1, -1, 76],
        [74, 11, -1, -1, 77, -2, -1, -1, 11, 76],
        [74, -2, -2, -1, 77, -1, -2, 11, -1, 76],
        [74, -1, -2, -2, 77, -1, -2,  5, -1, 76],
        [74, -1, -1, -2, 77, -1, -2, 11, -1, 76],
        [74, -1, 38, -2, 77, -2, -2, -1, -1, 76],
        [84, 85, 85, 85, 85, 85, 85, 85, 85, 86]
      ],
      _background_: "#860",
      _enemies_: [
        { b:"c", x: 288, y: 400, f: 1, l: 128, r: 448, t: 80, m: 1, d: 2, z:4 }, //bat
        { b:"c", x: 435, y: 320, f: 1, l: 128, r: 448, t: 40, d: 5 }, //wasp

        { b:"a", x: 320, y: 64, l: 256, r: 384, t: 52, m: 1, d: 25, z:8 }, //snail
        { b:"a", x: 288, y: 142, l: 256, r: 384, t: 260, d: 5 } // blob 
      ],
      _drop_: [
        { x: 5, y: 8, t: 37 }
      ],
      _portals_:{39:"y08"},
      _startx_: 288,
      _starty_: 512
    },

    y07: {
      //_title_: "",
      _map_: [
        [64, 65, 65, 65, 58, -2, 58, 65, 65, 66],
        [74, 58, 58, 58, 58, -2, 58, 58, 58, 76],
        [74, 58, 58, -1, -1, -2, -1, -1, 58, 76],
        [74, 58, -1, -1, -2, -2, -1, -1, -1, 76],
        [74, -1, -1, 34, -2, 34, -2, -1, -1, 76],
        [74, -1, 34, 34, -2, 34, -1, -2, -1, 76],
        [74, -1, 34, -2, -2, 34, 34, -2, -1, 76],
        [74, -1, 34, 34, -2, -2, 34, -1, -1, 76],
        [74, -1, -1, 34, -2, -2, 34, 38,  5, 76],
        [84, 85, 85, 85, 85, -2, 85, 85, 85, 86]
      ],
      _background_: "#860",
      _enemies_: [
        { b:"a", x: 200, y: 64, f: 1, l: 64, r: 512, t: 40, d: 5, z:6 }, //wasp
        { b:"a", x: 200, y: 192, f: 1, l: 64, r: 512, t: 40, d: 5, z:6 }, //wasp
        { b:"a", x: 200, y: 320, f: 1, l: 64, r: 512, t: 40, d: 5, z:6 }, //wasp
        { b:"a", x: 200, y: 448, f: 1, l: 64, r: 512, t: 40, d: 5, z:6 }, //wasp       
        { b:"b", x: 64, y: -50, l: -60, r: 512, t: 62, d: 5, z:8 }, // spider 
        { b:"b", x: 512, y: -50, l: -60, r: 512, t: 62, d: 5, z:8 } // spider
      ],
      _drop_: [
        { x: 5, y: 8, t: 37 }
      ],
      _portals_:{39:"y09"},
      _startx_: 288,
      _starty_: 512
    },

    y08: {
      //_title_: "",
      _map_: [
        [66, -2, 74, -1, -1, -1, -1, 76, 65, 66],
        [76, -3, 84, 85, 85, 85, 85, 86, -1, 76],
        [76, -2, 34, -1, -1, -1, 77, -1, -1, 76],
        [76, -2, 34, -1, -1, -1, 77, -1, -1, 76],
        [76, -2, 34, -1, -1, -1, 94, 69, 69, 76],
        [76, -2, 34, -2, -2, -1, 77, -1, -1, 76],
        [86, -2, 77, -2, -2, -2, 77,  5, 11, 76],
        [34, 34, 34, 34, 75, 75, 77, -1, -1, 76],
        [34, -2, -2, -2, -1, 75, 65, 66, -1, 76],
        [34, -2, 34, 83, -1, -1, -1, 76, 85, 86]
      ],
      _background_: "#860",
      _enemies_: [
        { b:"a", x: 96, y: 512, l: 64, r: 256, t: 260, d: 5 }, // blob 
        { b:"a", x: 360, y: 384, l: 64, r: 320, t: 50, d: 5, z:5 }, //worm
        { b:"a", x: 496, y: 192, l: 389, r: 512, t: 42, m: 1, d: 15, z:3 }, //frog
        { b:"a", x: 496, y: 270, f:1, l: 389, r: 512, t: 252, m: 1, d: 25, z:3 }, //snail

        { b:"c", x: 288, y: 320, f: 1, l: 64, r: 512, t: 80, m: 1, d: 2, z:4 }, //bat
        { b:"c", x: 435, y: 128, f: 1, l: 64, r: 512, t: 40, d: 5 }, //wasp
              
        { b:"c", x: 64, y: 192, l: 32, r: 546, t: 62, d: 5, z:10 }, // c-spider
        { b:"c", x: 512, y: 256, l: 32, r: 546, t: 62, d: 5, z:10 } // c-spider
      ],
      _drop_: [
        { x: 4, y: 4, t: 37 },
        { x: 8, y: 8, t: 25 } // switch
      ],
      _action_: [ 
        { l:"y09",  x: 7, y: 8, t: 38  } // door
      ],
      _startx_: 288,
      _starty_: 0
    },

    y09: {
      //_title_: "",
      _map_: [
        [64, 65, 65, 65, 65, 65, 65, 65, 65, 66],
        [74, -2, -2, -2, -2, -2, -2, -2, -2, 76],
        [74, -2, -2, -2, -2, -2,  5, -2, -2, 76],
        [74, 91, 21, 21, 21, 21, 21, 21, 21, 76],
        [74, -2, -2, -2, -2, -2, -2, -2, -2, 76],
        [74, 21, -2, -2, -2, -2, -2, -2, -2, 76],
        [74, 21, 21, -2, -2, -2, -2, -2, -2, 76],
        [74, 21, 21, 21, 91, -2, -2, -2, -2, 76],
        [74, 21, 21, 21, -2, -2, -2, -2, -2, 76],
        [84, 85, 85, 85, 85, 85, 85, 85, 85, 86]
      ],
      _background_: "#860",
      _enemies_: [
        { b:"c", x:128, y: 128, f: 1, l: 64, r: 512, t: 80, m: 1, d: 2, z:10 }, //c-bat
        { b:"c", x:192, y: 192, f: 1, l: 64, r: 512, t: 80, m: 1, d: 2, z:10 }, //c-bat
        { b:"c", x:256, y: 256, f: 1, l: 64, r: 512, t: 80, m: 1, d: 2, z:10 }, //c-bat
        { b:"c", x:384, y: 384, f: 1, l: 64, r: 512, t: 80, m: 1, d: 2, z:10 }, //c-bat
        { b:"c", x:448, y: 448, f: 1, l: 64, r: 512, t: 80, m: 1, d: 2, z:10 }, //c-bat
        { b:"a", x: 288, y: 256, l: 256, r: 384, t: 260, d: 5 } // blob  
      ],
      _drop_: [
        { x: 5, y: 8, t: 37 }
      ],
      _portals_:{39:"y10"},
      _startx_: 288,
      _starty_: 512
    },

    y10: {
      //_title_: "",
      _map_: [
        [64, 65, 65, 65, 65, 65, 65, 65, 65, 66],
        [74, -2, -2, -2,  5, -2, -2, -2, -2, 76],
        [74, -2, -2, -2, 95, 95, -2, -2, -2, 76],
        [74, -2, -2, -2, -2, -2, -2, -2, -2, 76],
        [74, 34, 34, 34, -2, -2, 34, 34, 34, 76],
        [74, -2, -2, -2, -2, -2, -2, -2, -2, 76],
        [74, -2, -2, -2, 95, 95, -2, -2, -2, 76],
        [74, -2, -2, 95, -2, -2, 95, -2, -2, 76],
        [74, -2, -2, -2, 38, -2, -2, -2, -2, 76],
        [84, 85, 85, 85, 85, 85, 85, 85, 85, 86]
      ],
      _background_: "#860",
      _enemies_: [

        { b:"a", x: 288, y: 400, f: 1, l: 256, r: 320, t: 80, m: 1, d: 2, z:4 }, //bat
        { b:"a", x: 435, y: 128, f: 1, l: 128, r: 448, t: 40, d: 5 }, //wasp
        { b:"a", x: 360, y: 192, l: 384, r: 512, t: 50, d: 5 }, //worm
        { b:"a", x: 64, y: 192, l: 64, r: 192, t: 42, m: 1, d: 15, z:3 }, //frog

        { b:"a", x: 288, y: 320, l: 256, r: 320, t: 60, d: 5 }, // blob 
        
        { b:"c", x: 64, y: 200, l: 32, r: 546, t: 62, d: 5, z:10 }, // c-spider
        { b:"c", x: 512, y: 90, l: 32, r: 546, t: 62, d: 5, z:10 } // c-spider
      ],
      _drop_: [
        { x: 5, y: 1, t: 37 }
      ],
      _portals_:{39:"ybs"},
      _startx_: 288,
      _starty_: 512
    },

    ybs: {
      _title_: "the end is near",
      _map_: [
        [13, 32, -2, 30, 31, 58, 58, 58, 58, 58],
        [22, -2, -2, -2, -2, -2, -2, -2, -2, 59],
        [22, -2, -2, -2, -2, -2, -2, -2, -2, 59],
        [22, -2, 21, 21, -2, -2, 75, 75, -2, 59],
        [22, -2, -1, -2, -2, -2, -1, -2, -1, 59],
        [34, -2, -2, -2, 21, 83, -1, -1, -1, 76],
        [34, -2, -2, -2, -2, -1, -1, -1, -1, 76],
        [34, 95,195, -2, -1, -1, -1, 82, 69, 76],
        [34, -2, -2, -2, -2, -1, -1, -1, -1, 76],
        [34, 34, -2, 34, 34, 85, 85, 85, 85, 86]
      ],
      _background_: "#430",
      _enemies_: [
  
         { b:"c", x: 288, y: 64, l: 64, r: 448, a:64, t: 62, d: 5, z:3, h:4, s:128, c:95 }, // big spider
         { b:"a", x: 145, y: 220, z:2, l: 160, r: 352, t: 40, d: 5, h:4, s: 128, c: 95 }, //big wasp      
         { b:"a", x: 288, y: 320, f: 1, l: 160, r: 352, t: 80, m: 1, d: 2, z:5, h:4, s:128, c:95 }, //big bat 
         { b:"a", x: 448, y: 448, f:1, l: 64, r: 448, t: 52, m: 1, d:48, z:8, h:1, s:128, c:95 } //big snail
       ],
      _drop_: [
        { x: 4, y: 3, t: 99, m:"back home" }, // yellow note

        // escape ladder
        { l: "s", x: 7, y:0, t:67 },
        { l: "s", x: 7, y:1, t:67 },
        { l: "s", x: 7, y:2, t:67 },
        { l: "s", x: 7, y:3, t:67 },

        { l: "s", x: 6, y:2, t:91 },

        { l: "s", x: 7, y:4, t:88 },

        { l: "s", x: 6, y:6, t:88 },

        { l: "s", x: 2, y:4, t:88 },
        { l: "s", x: 4, y:4, t:88 },

        { l: "s", x: 2, y:3, t:25 } // switch 
      ],
      _startx_: 64,
      _starty_: 512
    }
  };

  ///#define _level_ L
  ///#define _notes_ N
  _level_ = 0; // current level
  _notes_ = []; // active notes

  ///#define _flip_ P
  _flip_ = false;

  ///#define _frame_ F
  _frame_ = 0;

///#if UNMINIFIED
  TF = {
    _BlockLeft_: 1,
    _BlockRight_: 2,
    _BlockLeftRight_: 3,
    _BlockUp_: 4,
    _BlockLeftUp_: 5,
    _BlockRightUp_: 6,
    _BlockLeftRightUp_: 7,
    _BlockDown_: 8,
    _BlockLeftDown_: 9,
    _BlockRightDown_: 10,
    _BlockLeftRightDown_: 11,
    _BlockUpDown_: 12,
    _BlockLeftUpDown_: 13,
    _BlockRightUpDown_: 14,
    _BlockAll_: 15,
    _Portal_: 16, // portal - exit 
    _Tutorial_: 32,  // tutorial - these get cleared when you exit the level
    _Locked_: 64,
    _Collectable_: 128,
    _Switch_: 256,
    _Message_: 512,
    _Special_: 1024,
    _Mcguffin_: 1152,
  };
///#else
  ///#define TF._BlockLeft_ 1
  ///#define TF._BlockRight_ 2
  ///#define TF._BlockLeftRight_ 3
  ///#define TF._BlockUp_ 4
  ///#define TF._BlockLeftUp_ 5
  ///#define TF._BlockRightUp_ 6
  ///#define TF._BlockLeftRightUp_ 7
  ///#define TF._BlockDown_ 8
  ///#define TF._BlockLeftDown_ 9
  ///#define TF._BlockRightDown_ 10
  ///#define TF._BlockLeftRightDown_ 11
  ///#define TF._BlockUpDown_ 12
  ///#define TF._BlockLeftUpDown_ 13
  ///#define TF._BlockRightUpDown_ 14
  ///#define TF._BlockAll_ 15
  ///#define TF._Portal_ 16
  ///#define TF._Tutorial_ 32
  ///#define TF._Locked_ 64
  ///#define TF._Collectable_ 128
  ///#define TF._Switch_ 256
  ///#define TF._Message_ 512
  ///#define TF._Special_ 1024
  ///#define TF._Mcguffin_ 1152
///#endif

  ///#define _tileprops_ tps
  // Properties for the tiles
  _tileprops_ = [
    [0, 0, 0, 0, 0, TF._Collectable_, 0, TF._Collectable_, TF._Locked_, TF._Portal_],
    [TF._BlockRightDown_, TF._BlockLeftRightDown_, TF._BlockLeftDown_, 0, 0, 0, 0, TF._Collectable_, TF._Locked_, TF._Portal_],
    [TF._BlockRightUpDown_, TF._BlockAll_, TF._BlockLeftUpDown_, 0, 0, TF._Switch_, 0, TF._Collectable_, TF._Locked_, TF._Portal_],
    [TF._BlockRightUp_, TF._BlockLeftRightUp_, TF._BlockLeftUp_, 0, TF._BlockAll_, TF._BlockAll_, TF._BlockAll_, TF._Collectable_, TF._Locked_, TF._Portal_],
    [0, 0, 0, 0, TF._BlockAll_, TF._BlockAll_, TF._BlockAll_, 0, 0, 0],
    [0, 0, 0, 0, TF._BlockAll_, TF._BlockAll_, TF._BlockAll_, TF._Message_, TF._BlockAll_, TF._BlockAll_],
    [0, 0, 0, 0, TF._BlockAll_, TF._BlockAll_, TF._BlockAll_, TF._Portal_, TF._BlockAll_, TF._BlockDown_],
    [0, 0, TF._BlockDown_, 0, TF._BlockAll_, TF._BlockAll_, TF._BlockAll_, 0, TF._BlockUp_, TF._BlockRight_],
    [0, 0, TF._BlockDown_, TF._BlockDown_, TF._BlockAll_, TF._BlockAll_, TF._BlockAll_, 0, TF._BlockDown_, TF._BlockLeft_],
    [TF._Tutorial_, TF._Tutorial_, 0, 0, TF._BlockDown_, TF._BlockDown_, TF._Mcguffin_, TF._Mcguffin_, TF._Mcguffin_, TF._Mcguffin_]
  ];

  ///#define _savegame_ sg
  ///#define _loadgame_ lg
  _savegame_ = _ => {
    if (_monetization_) {
      try {
        localStorage.setItem("singsong", JSON.stringify(_world_))
      } catch(e) {}
    }
  };

  _loadgame_ = _ => { 
    try {
      x = localStorage.getItem("singsong");
      if (x) {
        _world_ = JSON.parse(x);
        _startLevel_(_world_._globalData_._levelname_);
        return true
      }
    } catch(e) {};

    return false
  };


  _newgame_ = _ => {
    try{
      localStorage.removeItem("singsong")
    } catch(e) {};
    location.reload()
  };


  ///#define _getMap_ gm
  ///#define _setMap_ sm
  ///#define _getMapProps_ mp
  ///#define _getTileProps_ tp
  ///#define _checkMapProp_ p
  _getMap_ = (x, y) => _level_._map_[Math.max(0, Math.min(9, Math.floor(y / 64)))][Math.max(0, Math.min(9, Math.floor(x / 64)))];
  _setMap_ = (x, y, i) => {
    _level_._map_[Math.max(0, Math.min(9, Math.floor(y / 64)))][Math.max(0, Math.min(9, Math.floor(x / 64)))] = i;
    _savegame_()
  };
  _getMapProps_ = (x, y) => _getTileProps_(_getMap_(x, y));
  _getTileProps_ = i => i < 0 ? 0 : _tileprops_[Math.floor((i%100) / 10)][i % 10];
  _checkMapProp_ = (x, y, p) => (_getMapProps_(x, y) & p) != 0;


  ///#define _name_ e
  ///#define _back_ b
  _startLevel_ = (_name_, _back_) => {
    dx = 0; dy = 0; _notes_ = [];
    s = false; // should we save?
    // clear tutorial markers on the level we're leaving
    if (_level_) {
      s = true;
      for (y = 0; y < 10; ++y) {
        for (x = 0; x < 10; ++x) {
          i = _level_._map_[y][x];
          if (_getTileProps_(i) & TF._Tutorial_) _level_._map_[y][x] = -1
        }
      }
    };

    /*--
    prettifyLevel(_name_);
    --*/

    _level_ = _world_[_name_];
    if (!_back_) {
      _level_.px = _level_._startx_;
      _level_.py = _level_._starty_
    };
    n.textContent = _level_._title_;
    if (_world_._globalData_._levelname_ && !_back_) {
      _world_._globalData_._stack_.push(_world_._globalData_._levelname_)
    };
    _world_._globalData_._levelname_ = _name_;

    g = _canvasContext_.createLinearGradient(0, 10, 0, 600);
    g.addColorStop(0, "#000");
    g.addColorStop(1, _level_._background_);
    _canvasContext_.fillStyle = g;

    if (_name_=="se") {
      // hide/show the right message on end screen based on progression
      if (!_world_._globalData_._inventory_[5]) _world_._globalData_._inventory_[5]=0;

      _level_._overlay_[1].h = (_world_._globalData_._inventory_[5] >= 20);
      _level_._overlay_[2].h = (_world_._globalData_._inventory_[5] < 20)||(_world_._globalData_._inventory_[5] >= 35);
      _level_._overlay_[3].h = (_world_._globalData_._inventory_[5] < 35)||(_world_._globalData_._inventory_[5] >= 50);
      _level_._overlay_[4].h = (_world_._globalData_._inventory_[5] < 50)
    };

    if (s) _savegame_()
  };

  ///#define _drawTile_ dt
  _drawTile_ = (x, y, i, s) => {
    s = s ? s : 64;
    _canvasContext_.save();
    _canvasContext_.translate(x,y);
    f = Math.floor(i/100);
    if (f&1) {
      // flip the tile horizontally
      _canvasContext_.scale(-1, 1);
      _canvasContext_.translate(-s,0)
    };
    if (f&2) {
      // flip vertically
      _canvasContext_.scale(1, -1);
      _canvasContext_.translate(0,-s)
    };
    if (f&4) {
      // rotate 90 degrees
      _canvasContext_.rotate(1.57); // PI/2
      _canvasContext_.translate(0,-s)
    };

    _canvasContext_.drawImage(_tiles_,
      i%10 *16, // x position in tilemap
      Math.floor(i%100 /10) *16, // y pos in tilemap
      16, 16, // size of tile
      0, 0, // destination x,y
      s, s // size to draw the tile
    );
  
    // reset the transformation matrix
    _canvasContext_.restore()
  
  };

  ///#define _doActions_ da
  _doActions_ = (d) => {
    if (d.l) {
      _world_[d.l]._map_[d.y][d.x] = d.t
    } else {
      _level_._map_[d.y][d.x] = d.t
    };  
    if (d.m) { _showMessage_(d.m) }
  };

  // very simple collision detection
  ///#define _hit_ h
  _hit_ = (x, x2, y, y2, r, r2, d) => Math.abs((x+r) - (x2+r2)) + Math.abs((y+r) - (y2+r2)) < (d?d:60);


///#if UNMINIFIED
  gemcount = 0;
///#endif

  prettifyLevel = (n) => {
    l = _world_[n];    
///#if UNMINIFIED
    hasgem = false;
///#endif
    if (l._map_) {
      for (y = 0; y < 10; ++y) {
        for (x = 0; x < 10; ++x) {
          r = _randomInt_(100);
///#if UNMINIFIED
          if (l._map_[y][x] == 5) {
            hasgem = true;
            gemcount++;
          }
///#endif
          if (l._map_[y][x] == 34) {
            // Randomize wall rocks
            l._map_[y][x] = 34 + _randomInt_(3) + (10 * _randomInt_(3)) + (100 * _randomInt_(8))
          } else if (l._map_[y][x] == 58 ) { // foliage block 
              l._map_[y][x] +=  (10 * _randomInt_(2)) + (100 * _randomInt_(8)) // random flipx/y
          } else if (l._map_[y][x] == 59 || l._map_[y][x] == 77) { // vertical trunk 
            l._map_[y][x] += (200 * _randomInt_(2)) // random flip y
          } else if (l._map_[y][x] == 69) { // horizontal branch             
            if (x>0  && l._map_[y][x-1]==-2) {
              // Branch with blank left
              l._map_[y][x]=82
            } else if (x<9 && l._map_[y][x+1]==-2) {
              // Branch with blank right
              l._map_[y][x]=83
            } else {
              if (r < 20) {
                l._map_[y][x]=72 + (100 * _randomInt_(2)) // random flip x
              } else {
                l._map_[y][x] += (100 * _randomInt_(2)) // random flip x
              }
            }
          } else if (l._map_[y][x] == -2) {
            if (n[0]=="s" || n[0]=="b" || n[0]=="r" || n[0]=="y") {
              // start, blue and red levels get 'cave' style        
              if (r < 20) {
                l._map_[y][x] = 16 + (100*_randomInt_(8)) // rocky pattern
              } else if (r < 24) {
                l._map_[y][x] = 6 // torch
              } else if (r < 40) {
                // planty sprouty things
                l._map_[y][x] = 47 + _randomInt_(3) + (100 * _randomInt_(8))
              } else if (r < 70 && y > 0 && _getTileProps_(l._map_[y - 1][x]) & TF._BlockUp_) {
                l._map_[y][x] = 87 + (100 * _randomInt_(2))// hanging things 
              } else if (r < 80 && y < 9 && _getTileProps_(l._map_[y + 1][x]) & TF._BlockDown_) {
                l._map_[y][x] = 33 +  (100 * _randomInt_(2))//grassy stuff
              }
            } else if (n[0]=="g") {
            // trees style for green levels
              if (r < 20 && y < 9 && _getTileProps_(l._map_[y + 1][x]) & TF._BlockDown_) {
                l._map_[y][x] = 73 +  (100 * _randomInt_(2)) //leafy stuff
              } 
            }        
          }
        }
      }
///#if UNMINIFIED
      if (!hasgem && !n.endsWith("s") && n[0] != "t" && n[0] != "s") {
        console.log("No gem on level "+n)
      } 
///#endif
    }

  };

///#if UNMINIFIED
  unlockAll = _ => {
    for (y = 0; y < 10; ++y) {
        for (x = 0; x < 10; ++x) {
          if ((_level_._map_[y][x] == 8) || (_level_._map_[y][x] == 18) || (_level_._map_[y][x] == 28) || (_level_._map_[y][x] == 38)) {
            _level_._map_[y][x] ++
          }
        }
      }
  }

  killAll = _ => {
    _level_._enemies_.forEach(e => {
      e._dead_ = true; // kill stunned enemy
      e.dy = -30 // enemy bounce death
    })
  }
///#endif

  ///#define _audioCtx_ _ax
  ///#define _playSound_ _s
  _audioCtx_ = 0;

  _playSound_ = (x, y) => {

    if (!_audioCtx_) {
      _audioCtx_ = new AudioContext
    };

    t = _audioCtx_.currentTime;

    with (_audioCtx_) {
      with (G = createGain()) {
        for (i in x) {
          with (createOscillator()) {
            if (x[i]) {
              connect(G),
              G.connect(destination),
              start(t + (i * y)),
              frequency.setValueAtTime((440 * 1.06 ** (13 - x[i])), t + (i * y)),
              type = "sawtooth",
              gain.setValueAtTime(0.2, t + (i * y)),
              //gain.setTargetAtTime(.0001,i*T,.005),
              stop(t + (i * y + (y)))
            }
          }
        }
      }
    }
  };




  ///#define _bumpSound_      za
  ///#define _jumpSound_      zb
  ///#define _noteSound_      zc
  ///#define _stunSound_      zd
  ///#define _dieSound_       ze
  ///#define _pickupSound_    zf
  ///#define _doorSound_      zg
  ///#define _switchSound_    zh
  ///#define _enemyKillSound_ zi
  ///#define _tune_           zj
  ///#define _bossTune_       zk

  _tune_ = _ => _playSound_([15,15,15,15,,15,15,,17,17,17,17,,17,17,,15,15,15,15,,15,15,,17,17,17,17,,17,17,,15,15,15,15,,15,15,,13,13,13,13,,13,13,,11,11,11,11,,15,15,,15,15,15,15], .05);
  _bossTune_ = _ => _playSound_([17,17,17,17,,16,16,,15,15,15,15,,16,16,,17,17,17,17,,16,16,,15,15,15,15,,16,16,,11,11,11,11,,12,12,,13,13,13,13,,13,13,,14,14,14,14,,15,15,,16,16,16,16], .05);

  _bumpSound_ = _ => _playSound_([17, 16, 18], .02);
  _jumpSound_ = _ => _playSound_([8, 7, 7, 6, 5, 4, 4], .02);
  _noteSound_ = _ => _playSound_([_randomInt_(25),_randomInt_(25),_randomInt_(25),_randomInt_(25)], .08);
  _stunSound_ = _ => _playSound_([5,5,6,5,5,6,5,5,6,5,5,6,5,5,6,5,5,6,5,5,6,5,5,6,5,5,6,6,7,7,8,9,9,8],.05);
  _dieSound_ = _ => _playSound_([5,4,3,2,1,1,1,2,3,4,5,6,7,8,9,10],.05);
  _pickupSound_ = _ => _playSound_([8,7,1],.05);
  _doorSound_ = _ => _playSound_([55,54,53,52,51,50,49,48],.03);
  _switchSound_ = _ => _playSound_([50,51,52,53,0,43,32,21],.01);
  _enemyKillSound_ = _ => _playSound_([1,,2,,3,,4,,5],.05);
 
///#if UNMINIFIED
  Object.getOwnPropertyNames(_world_).forEach(n => prettifyLevel(n));
///#endif

///#if UNMINIFIED
  console.log("Total gems:" +gemcount);
///#endif

///#if UNMINIFIED
  if (location.hash) {
    _startLevel_(location.hash.substr(1));
  }
  else {
///#else
  if (!_loadgame_()) _startLevel_("s");
///#endif
///#if UNMINIFIED
  }
///#endif

  ///#define _behaviours_ _bv
  _behaviours_ = {

    // sweep left to right
    a: e => {
      if (!e.m || e.m == e.i) { // only move on designated frame (e.g. frog jump)
        if (e.f) { // enemy moving left
          e.x -= e.z ? e.z : 1;
          if (e.x <= e.l) {
            e.f = false // enemy reached left limit, so flip
          }
        } else { // enemy moving right
          e.x += e.z ? e.z : 1;
          if (e.x >= e.r) {
            e.f = true // enemy reached right limit, so flip
          }
        }
      }
    },

    // climb up and down
    b: e => {
      if (e.f) { // enemy moving up
        e.y -= e.z ? e.z : 1;
        if (e.y <= e.l) {
          e.f = false // enemy reached top limit, so flip
        }
      } else { // enemy moving down
        e.y += e.z ? e.z : 1;
        if (e.y >= e.r) {
          e.f = true // enemy reached bottom limit, so flip
        }
      }
    },
    
    // spider hybrid
    c: e=> {
      if (_frame_%500 > 250) { 
        //dropping
        if (e.f) { // enemy moving up
          e.y -= e.z ? e.z : 1;
          if (e.y <= e.l) {
            e.f = false // enemy reached top limit, so flip
          }
        } else { // enemy moving down
          e.y += e.z ? e.z : 1;
          if (e.y >= e.r) {
            e.f = true // enemy reached bottom limit, so flip
          }
        }
     
      } else {
        if (e.f) { // enemy moving left
          e.x -= e.z ? e.z : 1;
          if (e.x <= e.l) {
            e.f = false // enemy reached left limit, so flip
          }
        } else { // enemy moving right
          e.x += e.z ? e.z : 1;
          if (e.x >= e.r) {
            e.f = true // enemy reached right limit, so flip
          }
        }
      }
    }
  };

  ///#define _handleGamepads_ gp

  // Game loop (30fps)
  setInterval(e => {

    // only pay attention to first gamepad entry
    _handleGamepads_(navigator.getGamepads());

    _frame_++;

    mx = dx;

    // apply x force from jump
    mx += jx;

    ///#define col_bl cbl
    ///#define col_bm cbm
    ///#define col_br cbr

    ///#define col_tl ctl
    ///#define col_tm ctm
    ///#define col_tr ctr

    // collision checks
    col_bl = _checkMapProp_(_level_.px + 12, _level_.py + 65, TF._BlockDown_);
    col_bm = _checkMapProp_(_level_.px + 32, _level_.py + 65, TF._BlockDown_);
    col_br = _checkMapProp_(_level_.px + 48, _level_.py + 65, TF._BlockDown_);

    col_tl = _checkMapProp_(_level_.px + 12, _level_.py + 5, TF._BlockUp_);
    col_tm = _checkMapProp_(_level_.px + 32, _level_.py + 5, TF._BlockUp_);
    col_tr = _checkMapProp_(_level_.px + 48, _level_.py + 5, TF._BlockUp_);

    // gravity
    if (_dead_) {
      dy += 3
    } else if (dy < 0) {
      dy += 1
    } else if ((!col_bl &&
                !col_bm &&
                !col_br)) {
      // Tile underneath *doesn't* block downwards motion
      dy += 1
    };

    if (!_dead_ && _checkMapProp_(_level_.px + 32, _level_.py + 32, TF._Collectable_)) {
      t = _getMap_(_level_.px + 32, _level_.py + 32);
///#if UNMINIFIED
      console.log("Collectable " + t);
///#endif
      if (_world_._globalData_._levelname_ !== "s") { // prevent player picking up notes from start screen!
        if (_getTileProps_(t) & TF._Special_) {
          // one of the note blocks
          // put it on the opening screen
          // silly remap because I switched world order!
          if (t==96) {x=3} else if(t==97) {x=5} else if (t==98) {x=4} else x=6;
          _world_["s"]._map_[5][x] = t;
          _world_._globalData_._notes_++ 
        } else {
          // put it in the inventory
          if (!_world_._globalData_._inventory_[t]) {
            _world_._globalData_._inventory_[t] = 1
          } else {
            _world_._globalData_._inventory_[t]++
          }
        };
        _setMap_(_level_.px + 32, _level_.py + 32, -1);
        _pickupSound_()
      }
    };

    // check if the tile being moved into in horizontal direction is empty (-1)
    if (mx > 0) {
      if (_checkMapProp_(_level_.px + 60, _level_.py + 32, TF._BlockRight_) ||
          _checkMapProp_(_level_.px + 60, _level_.py + 5, TF._BlockRight_)) {
        mx = 0
      }
    } else if (mx < 0) {
      if (_checkMapProp_(_level_.px + 3, _level_.py + 32, TF._BlockLeft_) ||
          _checkMapProp_(_level_.px + 3, _level_.py + 5, TF._BlockLeft_)) {
        mx = 0
      }
    };
    if (!_dead_) {
      // check in vertical direction
      if (dy > 0) {
        if (col_bl || col_bm || col_br) {
          dy = 0;
          _bumpSound_()
        }
      } else if (dy < 0) {
        if (col_tl || col_tm || col_tr) {
          dy = 0;
          _bumpSound_()
        }
      };
      dy = Math.min(dy, 15) // max fall speed
    };

    if (mx != 0) {
      pf = (Math.floor(_frame_ / 5) % 3)
    } else {
      pf = 0
    };

    // don't embed in floor when falling
    // BUG:  Get sucked up through 'BlockDown' floors
    if (!_dead_ && dy >= 0 && (_level_.py>64) && ((_level_.py%64)<32)) {
      while ((_level_.py>64) && _checkMapProp_(_level_.px + 31, _level_.py + 64, TF._BlockDown_)) {
        _level_.py--;
        dy = 0
      }
    };

    // apply motion to player
    _level_.px += mx;
    _level_.py += dy;

    // apply wall jump horizontal motion
    if (jx != 0) {
      jx -= (Math.sign(jx));
      if (jx == 0) {
        dx = 0
      }
    };

    // clear the canvas
    _canvasContext_.fillRect(0, 0, 640, 640);

    // draw the map
    for (y = 0; y < 10; ++y) {
      for (x = 0; x < 10; ++x) {
        i = _level_._map_[y][x];
        if (i > -1) {
          // Make torches flicker
          f = (i == 6) && (_frame_ % 6) < 3;
          // make arrows flash
          if ((i%100) != 91 || ((_frame_+(y*5))%50 > 40)) _drawTile_(x * 64, y * 64, i + (f ? 100 : 0))
        }
      }
    };

    // Wrap player around top and bottom
    if (_level_.py > 640) {
      _level_.py = -60;
      if (_dead_) {
        _goBack_(); // enemy not stunned, so 'kill' player
        _dead_ = false
      }
    };
    if (_level_.py < -60) {
      _level_.py = 640
    };

    f = pf;
    if (dy < 0) { // moving vertically
      f = 4 // jumping
    } else if (dy > 0) {
      f = 3 // falling
    };

    // draw player
    if (!_invunerable_ || _invunerable_ % 10 < 5)  _drawTile_(_level_.px, _level_.py, f + (_flip_ ? 100 : 0));

    // handle enemies
    if (_level_._enemies_) {
      _level_._enemies_.forEach(e => {

        if (e._dead_) {
          // fall anim if dead
          e.dy += 5;
          e.y += e.dy
        } else {
          // check collision with notes
          _notes_.forEach(n => {
            if ((!e.k) && _hit_(e.x, n.dx, e.y, n.y, e.s?e.s/2:32, 32, e.c)) { e.k = 50; _stunSound_()} // hit enemy, so stun it        
          });

          if (!_dead_ && !_invunerable_ && _hit_(e.x, _level_.px, e.y, _level_.py, e.s?e.s/2:32, 32, e.c)) {
            if (e.k > 0) {           
              if (e.h) {           
                e.h--; // decrease boss HP 
                e.k = 0;
                _invunerable_ = 30; // stop player getting hurt
                e.z += 2; // speed up boss
                e.y -= 50
              };
              if (!e.h) {
                _enemyKillSound_();
                e._dead_ = true; // kill stunned enemy
                e.dy = -30 // enemy bounce death
              }
            } else {
              // player killed by enemy
              _dieSound_();
              _dead_ = true;
              dy = -30 // bounce death
            }
          };

          if (e.k > 0) {
            // enemy stunned
            e.f = ((_frame_ / 5) % 10) < 5;
            e.k--;
            if (_frame_ % 2 == 0) { return } // only draw alternate frames, to make it flash
          } else {
            // perform enemy behaviour
            _behaviours_[e.b](e);
            e.i = (Math.floor(_frame_ / e.d) % 2)
          }
        };
        _drawTile_(e.x, e.y, e.t + e.i + (e.f ? 100 : 0), (e.s ? e.s : 64) )
      });

      if (_level_._enemies_.length) {
        // filter out dead enemies
        _level_._enemies_ = _level_._enemies_.filter(e => e.y < 640);
        if (_level_._enemies_.length == 0) {
          // no enemies left - level finished, do drops
          if (_level_._drop_) {
            _level_._drop_.forEach(d => _doActions_(d))
          }
        }
      }
    };

    // update notes
    _notes_.forEach(n => {
      n.y -= 10;
      n.dx = n.x + (Math.sin(n.f * (_frame_ - n.s) / 10) * 64);
      _drawTile_(n.dx, n.y, n.i)
    });
    // filter out notes that have left the screen
    _notes_ = _notes_.filter(n => n.y > -64);


    // draw inventory
    y = 4;
    g = _canvasContext_.fillStyle;
    _canvasContext_.fillStyle = "#ffa";
    _canvasContext_.font = "bold 24px sans-serif";

    for (i in _world_._globalData_._inventory_) {
      if (_world_._globalData_._inventory_[i]) {
        _drawTile_(4, y, i, 32);
        _canvasContext_.strokeText(_world_._globalData_._inventory_[i], 50, y + 28);
        _canvasContext_.fillText(_world_._globalData_._inventory_[i], 50, y + 28);
        y += 33
      }
    };

    // draw overlays
    if (_level_._overlay_) {
      _level_._overlay_.forEach(e => {
        if (!e.h) {
          _canvasContext_.font = e.f;
          _canvasContext_.fillStyle = e.c;
          _canvasContext_.strokeText(e.t, e.x, e.y);
          _canvasContext_.fillText(e.t, e.x, e.y)
        }
      })
    };

    _canvasContext_.fillStyle = g;

    if (_invunerable_) _invunerable_--;

    // display any level messages
    if (_checkMapProp_(_level_.px + 32, _level_.py + 32, TF._Message_)) _showMessage_(_level_._message_)

  }, 33);

  ///#define _jump_ _j
  _jump_ = false;
  _keyDown_ = (x, e) => {
    if (_dead_) { _cancelEvent_(e); return };
    if (x == 39) { // right
      dx = 4;
      jx = 0;
      _flip_ = false;
      _cancelEvent_(e)
    };
    if (x == 37) { // left
      dx = -4;
      jx = 0;
      _flip_ = true;
      _cancelEvent_(e)
    };
    if (x == 32) { // space
      if (!_jump_) {
        // jump  
        // ensure solid platform below us (blocks d) and are in empty space
        if ( _checkMapProp_(_level_.px + 12, _level_.py + 66, TF._BlockDown_) ||
             _checkMapProp_(_level_.px + 32, _level_.py + 66, TF._BlockDown_) ||
             _checkMapProp_(_level_.px + 48, _level_.py + 66, TF._BlockDown_) ) {
          dy = -17;
          _jumpSound_()
        } else if (_flip_ && _checkMapProp_(_level_.px + 3, _level_.py + 32, TF._BlockLeft_)) {
          // wall jump
          dy = -12;
          jx = 8;
          _flip_ = false;
          _jumpSound_()
        } else if (!_flip_ && _checkMapProp_(_level_.px + 60, _level_.py + 32, TF._BlockRight_)) {
          dy = -12;
          jx = -8;
          _flip_ = true;
          _jumpSound_()
        };
        _jump_ = true
      };
      _cancelEvent_(e)
    };
    if (x == 38) { // up
      if (_checkMapProp_(_level_.px + 32, _level_.py + 32, TF._Locked_)) {
        // in front of locked door

        t = _getMap_(_level_.px + 32, _level_.py + 32);
        k = (t % 100)-1;
  ///#if UNMINIFIED
        console.log("locked door " + t);
  ///#endif

        if (_world_._globalData_._inventory_[k] > 0) {
          // use key
          _world_._globalData_._inventory_[k]--;
          _setMap_(_level_.px + 32, _level_.py + 32, t + 1) // unlock door
        }
      };
      if (_checkMapProp_(_level_.px + 32, _level_.py + 32, TF._Portal_)) {
        // in front of open door

        t = _getMap_(_level_.px + 32, _level_.py + 32);

  ///#if UNMINIFIED
        console.log("open door " + t);
  ///#endif

        _startLevel_(_level_._portals_[t]);
        if (_world_._globalData_._levelname_[2]=="1") _tune_(); // levelname ends with a '1' so it's the first stage in a world (until we add world 11!)
        else if (_world_._globalData_._levelname_[2]=="s")_bossTune_(); // levelname ends with an 's' so it's boss stage
        else _doorSound_()
      };
      if (_checkMapProp_(_level_.px + 32, _level_.py + 32, TF._Switch_)) {
        // in front of switch

        t = _getMap_(_level_.px + 32, _level_.py + 32);

  ///#if UNMINIFIED
        console.log("switch" + t);
  ///#endif
        _setMap_(_level_.px + 32, _level_.py + 32, t + 1);
        _level_._action_.forEach(d => _doActions_(d));
        _switchSound_()
      };
      _cancelEvent_(e)
    };
    if (x == 18) { // lalt - shoot
      if (_notes_.length < 3) {
        _noteSound_();
        _notes_.push({ x: _level_.px, y: _level_.py, i: 15, s: _frame_, f: _flip_ ? -1 : 1 })
      };
      _cancelEvent_(e)
    };
    if (x == 27) { // esc - home
      _cancelEvent_(e);
      _startLevel_("s"); 
      _world_._globalData_._stack_ = []
    };
    if (x == 8) { // backspace - back
      _cancelEvent_(e);
      _goBack_()
    }
  };

  _keyUp_ = (x, e) => {
    if (x == 32) {
      _jump_ = false;
      _cancelEvent_(e)
    };
    if (x == 39 || x == 37) {
      dx = 0;
      _cancelEvent_(e)
    };
    if (x == 18 || x == 27 || x == 8) {
      _cancelEvent_(e)
    }
  };

  // Keyboard events
  onkeydown = e => _keyDown_(e.keyCode, e);
  onkeyup = e => _keyUp_(e.keyCode, e);

  // gamepad
  _handleGamepads_d = []; // track which buttons are currently down
  _handleGamepads_ = e => {
    // Assuming standard mapping
    // https://w3c.github.io/gamepad/#remapping
    b=[];
    
    for(i=0; i<4; i++) {
      if (e[i]&& e[i].mapping) { // ignore any gamepads without a full complement of buttons!
        
        // map left stick to dpad buttons
        b[12]=e[i].axes[1]<-0.5;
        b[14]=e[i].axes[0]<-0.5;
        b[15]=e[i].axes[0]>0.5; 
          
        // button id -> keycode
        [ [ 0, 18], // fire
          [ 1, 32], // jump
          [ 8,  8], // back
          [ 9, 27], // home (start)
          [12, 38], // up
          [14, 37], // left
          [15, 39]  // right
        ].forEach( x => {
          try {
            if ((e[i].buttons[x[0]].pressed) || b[x[0]]) {
              if (!_handleGamepads_d[x[0]]) { // button not already pressed
                _keyDown_(x[1]);
                _handleGamepads_d[x[0]] = true
              }
            } else if (_handleGamepads_d[x[0]]) {
              _keyUp_(x[1]);
              _handleGamepads_d[x[0]] = false
            }
          } catch (_){}
        })
      } 
    }
  }

</script>
